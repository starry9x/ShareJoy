{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/groups.css') }}">
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <div class="header-left">
            <a href="{{ url_for('groups') }}" class="back-btn">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <div class="group-info">
                <div class="group-avatar">
                    {% if group.image_url and group.image_url != 'default_group.jpg' %}
                        <img src="{{ url_for('static', filename='images/' + group.image_url) }}" alt="{{ group.name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                    {% else %}
                        {% if 'board' in group.name.lower() %}
                            <i class="fa-solid fa-chess-board"></i>
                        {% elif 'walk' in group.name.lower() or 'nature' in group.name.lower() %}
                            <i class="fa-solid fa-person-hiking"></i>
                        {% else %}
                            <i class="fa-solid fa-users"></i>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="group-details">
                    <h2>{{ group.name }}</h2>
                    <p>{{ active_members_count }} Active</p>
                </div>
            </div>
        </div>
        <a href="{{ url_for('group_settings', group_id=group.id) }}" class="settings-btn">
            <i class="fa-solid fa-gear"></i>
        </a>
    </div>

    <!-- Tabs -->
    <div class="chat-tabs">
        <a href="{{ url_for('group_chat', group_id=group.id) }}" class="tab-link active">Community Chat</a>
        <a href="{{ url_for('group_feed', group_id=group.id) }}" class="tab-link">Community Feed</a>
    </div>

    <!-- Mood Status - Only show if buddy is feeling down -->
    {% if buddy_feeling_down and buddy %}
    <div class="mood-status-bar">
        Your buddy {{ buddy.user_name }} is feeling down today {{ buddy.mood_status }}. Chat with them to make their day better?
    </div>
    {% endif %}

    <div class="mood-status-selector">
        <span class="mood-label">Mood Status: {{ member.mood_status }}</span>
        <form method="POST" action="{{ url_for('update_mood', group_id=group.id) }}" style="display: inline;">
            <div class="mood-options">
                <button type="submit" name="mood" value="ðŸ˜Š" class="mood-btn">ðŸ˜Š</button>
                <button type="submit" name="mood" value="ðŸ˜”" class="mood-btn">ðŸ˜”</button>
                <button type="submit" name="mood" value="ðŸ˜„" class="mood-btn">ðŸ˜„</button>
                <button type="submit" name="mood" value="ðŸ˜¢" class="mood-btn">ðŸ˜¢</button>
                <button type="submit" name="mood" value="ðŸ˜´" class="mood-btn">ðŸ˜´</button>
            </div>
        </form>
    </div>

    <!-- Messages -->
    <div class="messages-area">
        {% for message in messages %}
        <div class="message {% if message.username == current_user %}own{% endif %}">
            <div class="message-wrapper">
                <div class="message-avatar">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="message-content">
                    <div class="message-author">{{ message.username }}</div>
                    <p class="message-text">{{ message.content }}</p>
                </div>
                {% if message.username == current_user %}
                <button class="delete-message-btn" data-message-id="{{ message.id }}" title="Delete message">
                    <i class="fa-solid fa-trash"></i>
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <div class="message">
            <div class="message-avatar">
                <i class="fa-solid fa-user"></i>
            </div>
            <div class="message-more">...</div>
        </div>
    </div>

    <!-- Input -->
    <div class="message-input-area">
        <form method="POST" class="input-form">
            <input type="hidden" name="username" value="{{ current_user }}">
            <input type="text" name="content" class="message-input" placeholder="Type a message..." required>
            <div class="input-icons">
                <button type="button" class="icon-btn"><i class="fa-solid fa-microphone"></i></button>
                <button type="button" class="icon-btn"><i class="fa-solid fa-paperclip"></i></button>
                <button type="button" class="icon-btn"><i class="fa-solid fa-face-smile"></i></button>
            </div>
            <button type="submit" class="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
        </form>
    </div>
</div>

<script>
    // Delete message functionality
    document.querySelectorAll('.delete-message-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this message?')) {
                const messageId = this.getAttribute('data-message-id');
                const messageElement = this.closest('.message');

                // Send delete request to server
                fetch(`/group/message/${messageId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove message from DOM with animation
                        messageElement.style.opacity = '0';
                        messageElement.style.transform = 'translateX(-20px)';
                        setTimeout(() => {
                            messageElement.remove();
                        }, 300);
                    }
                })
                .catch(error => {
                    console.error('Error deleting message:', error);
                    alert('Failed to delete message. Please try again.');
                });
            }
        });
    });
</script>
{% endblock %}
