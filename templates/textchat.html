{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/textchat.css') }}">
{% endblock %}

{% block content %}
<div class="section-box">
  <!-- Arrow pinned left -->
  <a href="{{ url_for('messages') }}" class="btn btn-link p-0 back-arrow">
    <i class="fa-solid fa-arrow-left"></i>
  </a>

  <!-- Centered group -->
  <div class="text-pfp-container">
    <img src="{{ url_for('static', filename=(contact.image_url if contact.image_url else 'images/default_pfp.jpg')) }}"
         alt="{{ contact.name }} picture" class="pfp">
    <span class="contact-name fw-semibold">{{ contact.name }}</span>
  </div>
</div>

<!-- Wrapper for chat + pane -->
<div class="chat-wrapper">
  <div class="chat-container" id="chatContainer">
    <div class="messages-area">
      <div class="p-3 mb-3 rounded shadow-sm box1">
        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
          <!-- Search form for messages -->
          <form method="get" class="flex-grow-1 mb-2 mb-md-0 box2 rounded" id="message-search-form">
            <input type="hidden" name="contact_id" value="{{ contact.id }}">
            <div class="input-group">
              <input type="text" name="search" class="form-control shadow-sm searchbar"
                placeholder="Search messages in this chat..." value="{{ request.args.get('search', '') }}">
              <button class="btn search-btn" type="submit">
                <i class="fa-solid fa-magnifying-glass"></i>
              </button>
              {% if request.args.get('search') %}
                <a href="{{ url_for('textchat', contact_id=contact.id) }}" class="btn btn-secondary ms-2">
                  Clear
                </a>
              {% endif %}
            </div>
          </form>
        </div>
      </div>

      {% for day, day_messages in messages|groupby('date_only') %}
        <div class="day-label">{{ day.strftime("%A, %d %b %Y") }}</div>
        {% for message in day_messages %}
          <div id="message-{{ message.id }}" class="message {% if message.username == user.full_name %}sent{% else %}received{% endif %}">
            <p>{{ message.content }}</p>
            {% if message.username == user.full_name %}
              <div class="message-actions">
                <!-- Delete Button (Hidden when edit form is active) -->
                <button type="button" class="btn redbtn btn-sm fw-semibold shadow-sm delete-btn" onclick="confirmDelete({{ message.id }})">Delete</button>

                <!-- Edit Button (Triggers Inline Form) -->
                <button type="button" class="edit-btn btn edit" onclick="startEdit(this)">Edit</button>

                <!-- Inline Edit Form (Hidden by Default) -->
                <form method="post" action="{{ url_for('update_message', message_id=message.id) }}" class="edit-form" style="display:none;">
                  <label for="editContent{{ message.id }}" class="form-label fw-semibold edit-label">Edit your message:</label>
                  <textarea id="editContent{{ message.id }}" name="content" class="edit-input form-control">{{ message.content }}</textarea>
                  <div class="update-buttons">
                    <button type="button" class="btn dobtn fw-semibold" onclick="confirmEdit({{ message.id }})">Save Changes</button>
                    <button type="button" class="btn cancel-btn fw-semibold" onclick="cancelEdit(this)">Cancel</button>
                  </div>
                </form>
              </div>
            {% endif %}
            <small>{{ message.timestamp|onlytime }}</small>
          </div>

          <!-- Delete Message Modal -->
          <div class="modal fade" id="deleteModal{{ message.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ message.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content p-2">
                <div class="modal-header">
                  <h4 class="modal-title fw-bold" id="deleteModalLabel{{ message.id }}">Delete Message</h4>
                </div>
                <div class="modal-body">
                  Are you sure you want to delete this message?<br>
                  <span class="fw-semibold text-danger">This action cannot be undone.</span>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary fw-semibold" data-bs-dismiss="modal">Cancel</button>
                  <form method="post" action="{{ url_for('delete_text_message', message_id=message.id) }}">
                    <button type="submit" class="btn btn-danger fw-semibold">Delete Message</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Edit Message Modal -->
          <div class="modal fade" id="editConfirmModal{{ message.id }}" tabindex="-1" aria-labelledby="editConfirmModalLabel{{ message.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content p-2">
                <div class="modal-header">
                  <h4 class="modal-title fw-bold" id="editConfirmModalLabel{{ message.id }}">Confirm Edit</h4>
                </div>
                <div class="modal-body">
                  Are you sure you want to save these changes?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary fw-semibold" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary fw-semibold" onclick="submitEditForm({{ message.id }})">Save Changes</button>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% endfor %}

      <!-- Display "No results" if no messages match the search -->
      {% if request.args.get('search') and messages|length == 0 %}
        <div class="text-center mt-4">
          <p class="text-muted">No results found for "{{ request.args.get('search') }}".</p>
        </div>
      {% endif %}
    </div>

    <form method="POST" class="input-area">
      <input type="text" name="content" class="message-input" placeholder="Type a message..." required>

      <!-- Attach Media -->
      <div class="media-dropdown">
        <button type="button" id="attachMediaButton" class="media-btn fw-semibold do-btn btn">Attach Media</button>
        <div id="mediaMenu" class="media-menu">
          <button type="button" class="media-option">ðŸ“· Attach Image</button>
          <button type="button" class="media-option">ðŸŽ¤ Record Voice</button>
        </div>
      </div>

      <!-- Toggle Chat Functions -->
      <button type="button" id="togglePaneButton" class="chat-tools-btn do-btn btn fw-semibold" onclick="togglePane()">Open chat starters</button>

      <!-- Send -->
      <button type="submit" class="send-btn do-btn btn fw-semibold">Send</button>
    </form>
  </div>

  <!-- Right pane -->
  <div class="right-pane" id="rightPane">
    <h5>Chat starters</h5>
    <div class="convo-starters">
      <p>Click on a chat starter template to start a conversation! </p>
      <button type="button" class="btn btn-sm btn-outline-secondary mb-4" onclick="insertText('What was your favourite memory of us together?')">What was your favourite memory of us together?</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mb-4" onclick="insertText('Share your most memorable childhood experience.')">Share your most memorable childhood experience.</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mb-4" onclick="insertText('Do you remember when we used to [insert text here]?')">Do you remember when we used to...</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mb-4" onclick="insertText('What are your favourite hawker foods?')">What are your favourite hawker foods?</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
window.onload = function() {
  const chatContainer = document.getElementById("chatContainer");
  chatContainer.scrollTop = chatContainer.scrollHeight;
};

function togglePane() {
  const pane = document.getElementById("rightPane");
  const chat = document.getElementById("chatContainer");
  const toggleButton = document.getElementById("togglePaneButton");

  pane.classList.toggle("open");
  chat.classList.toggle("shrunk");

  if (pane.classList.contains("open")) {
    toggleButton.textContent = "Close chat starters";
  } else {
    toggleButton.textContent = "Open chat starters";
  }
}

function insertText(text) {
  const inputField = document.querySelector(".message-input");
  inputField.value = text; // Insert the text into the input field
  inputField.focus(); // Focus the input field for user convenience
}

function startEdit(button) {
  const messageDiv = button.closest(".message");
  const textP = messageDiv.querySelector("p");
  const editForm = messageDiv.querySelector(".edit-form");
  const deleteBtn = messageDiv.querySelector(".delete-btn");

  // Hide text, edit button, and delete button
  textP.style.display = "none";
  button.style.display = "none";
  if (deleteBtn) deleteBtn.style.display = "none";

  // Show edit form
  editForm.style.display = "block";
}

function cancelEdit(button) {
  const editForm = button.closest(".edit-form");
  const messageDiv = editForm.closest(".message");
  const textP = messageDiv.querySelector("p");
  const editBtn = messageDiv.querySelector(".edit-btn");
  const deleteBtn = messageDiv.querySelector(".delete-btn");

  // Hide edit form
  editForm.style.display = "none";

  // Show text, edit button, and delete button again
  textP.style.display = "block";
  editBtn.style.display = "inline-block";
  if (deleteBtn) deleteBtn.style.display = "inline-block";
}

document.getElementById("attachMediaButton").addEventListener("click", function() {
  const menu = document.getElementById("mediaMenu");
  menu.style.display = (menu.style.display === "block") ? "none" : "block";
});

function startEdit(button) {
  const messageDiv = button.closest(".message");
  const textP = messageDiv.querySelector("p");
  const editForm = messageDiv.querySelector(".edit-form");
  const deleteBtn = messageDiv.querySelector(".delete-btn");

  // Hide text and buttons
  textP.style.display = "none";
  button.style.display = "none";
  if (deleteBtn) deleteBtn.style.display = "none";

  // Show edit form
  editForm.style.display = "block";
}

function cancelEdit(button) {
  const editForm = button.closest(".edit-form");
  const messageDiv = editForm.closest(".message");
  const textP = messageDiv.querySelector("p");
  const editBtn = messageDiv.querySelector(".edit-btn");
  const deleteBtn = messageDiv.querySelector(".delete-btn");

  // Hide edit form
  editForm.style.display = "none";

  // Show text and buttons again
  textP.style.display = "block";
  editBtn.style.display = "inline-block";
  if (deleteBtn) deleteBtn.style.display = "inline-block";
}

function confirmEdit(messageId) {
  // Open the edit confirmation modal
  const modal = new bootstrap.Modal(document.getElementById(`editConfirmModal${messageId}`));
  modal.show();
}

function submitEditForm(messageId) {
  // Submit the inline edit form
  const editForm = document.querySelector(`#message-${messageId} .edit-form`);
  editForm.submit();
}

function confirmDelete(messageId) {
  // Open the delete confirmation modal
  const modal = new bootstrap.Modal(document.getElementById(`deleteModal${messageId}`));
  modal.show();
}

</script>

{% if highlight_id %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const target = document.getElementById("message-{{ highlight_id }}");
  if (target) {
    target.classList.add("highlight");
    target.scrollIntoView({ behavior: "smooth", block: "center" });
  }
});
</script>
{% endif %}

{% endblock %}