{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/groups.css') }}">
{% endblock %}

{% block content %}
<div class="edit-container">
    <div class="edit-header">
        <a href="{{ url_for('group_settings', group_id=group.id) }}" class="back-link">
            <i class="fa-solid fa-arrow-left"></i> Back to Settings
        </a>
        <h1 class="edit-title">Group Details</h1>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <!-- Avatar Section -->
        <div class="avatar-section">
            <div class="avatar-preview" id="avatarPreview">
                {% if group.image_url and group.image_url != 'default_group.jpg' %}
                    <img src="{{ url_for('static', filename='images/' + group.image_url) }}" alt="{{ group.name }}">
                {% else %}
                    {% if 'board' in group.name.lower() %}
                        <i class="fa-solid fa-chess-board"></i>
                    {% elif 'walk' in group.name.lower() or 'nature' in group.name.lower() %}
                        <i class="fa-solid fa-person-hiking"></i>
                    {% else %}
                        <i class="fa-solid fa-users"></i>
                    {% endif %}
                {% endif %}
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <label for="groupImage" class="upload-label">
                    <i class="fa-solid fa-camera"></i> Change Group Picture
                </label>
                <input type="file" id="groupImage" name="group_image" accept="image/*" style="display: none;">

                {% if group.image_url and group.image_url != 'default_group.jpg' %}
                <button type="submit" name="delete_image" value="1" class="upload-label" style="background-color: #FFCDD2; color: #C62828; border: none; cursor: pointer;" onclick="return confirm('Are you sure you want to delete the group picture?');">
                    <i class="fa-solid fa-trash"></i> Delete Group Picture
                </button>
                {% endif %}

                <p style="font-size: 0.85rem; color: #757575; margin: 0;">Max 5MB. PNG, JPG, or GIF</p>
            </div>
        </div>

        <!-- Form Fields -->
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Group Name <span class="required">*</span></label>
                <input type="text" name="name" id="groupName" class="form-input" value="{{ group.name }}" maxlength="100" required>
                <div class="char-counter" id="nameCounter">{{ group.name|length }} / 100 characters</div>
                <div class="error-message" id="nameError">Please enter a group name between 3 and 100 characters.</div>
            </div>

            <div class="form-group">
                <label class="form-label">Group Category <span class="required">*</span></label>
                <input type="text" name="category" id="groupCategory" class="form-input" value="{{ group.category }}" maxlength="50" required>
                <div class="char-counter" id="categoryCounter">{{ group.category|length }} / 50 characters</div>
                <div class="error-message" id="categoryError">Please enter a category between 2 and 50 characters.</div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Description <span class="required">*</span></label>
            <textarea name="description" id="groupDescription" class="form-textarea" maxlength="500" required>{{ group.description }}</textarea>
            <div class="char-counter" id="descCounter">{{ group.description|length }} / 500 characters</div>
            <div class="error-message" id="descError">Please enter a description between 10 and 500 characters.</div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Group Size <span class="required">*</span></label>
                <input type="number" name="max_participants" id="maxParticipants" class="form-input" value="{{ group.max_participants }}" min="1" max="500" required>
                <div class="error-message" id="participantsError">Please enter a number between 1 and 500.</div>
            </div>

            <div class="form-group">
                <label class="form-label">Group Privacy <span class="required">*</span></label>
                <div class="privacy-buttons">
                    <label class="privacy-btn {% if group.privacy == 'Public' %}active{% endif %}">
                        <input type="radio" name="privacy" value="Public" {% if group.privacy == 'Public' %}checked{% endif %}>
                        Public
                    </label>
                    <label class="privacy-btn {% if group.privacy == 'Private' %}active{% endif %}">
                        <input type="radio" name="privacy" value="Private" {% if group.privacy == 'Private' %}checked{% endif %}>
                        Private
                    </label>
                </div>
            </div>
        </div>

        <button type="submit" class="btn-save">Save</button>
    </form>
</div>

<script>
    // ========== Real-time Field Validation ==========

    // Group Name Validation
    const groupNameInput = document.getElementById('groupName');
    const nameCounter = document.getElementById('nameCounter');
    const nameError = document.getElementById('nameError');

    groupNameInput.addEventListener('input', function() {
        const length = this.value.length;
        nameCounter.textContent = `${length} / 100 characters`;

        if (length > 90) {
            nameCounter.classList.add('warning');
        } else {
            nameCounter.classList.remove('warning');
        }

        if (length === 0) {
            this.classList.remove('success', 'error');
            nameError.classList.remove('show');
        } else if (length < 3) {
            this.classList.add('error');
            this.classList.remove('success');
            nameError.textContent = 'Group name must be at least 3 characters long.';
            nameError.classList.add('show');
        } else if (length > 100) {
            this.classList.add('error');
            this.classList.remove('success');
            nameError.textContent = 'Group name cannot exceed 100 characters.';
            nameError.classList.add('show');
        } else {
            this.classList.add('success');
            this.classList.remove('error');
            nameError.classList.remove('show');
        }
    });

    // Category Validation
    const categoryInput = document.getElementById('groupCategory');
    const categoryCounter = document.getElementById('categoryCounter');
    const categoryError = document.getElementById('categoryError');

    categoryInput.addEventListener('input', function() {
        const length = this.value.length;
        categoryCounter.textContent = `${length} / 50 characters`;

        if (length > 45) {
            categoryCounter.classList.add('warning');
        } else {
            categoryCounter.classList.remove('warning');
        }

        if (length === 0) {
            this.classList.remove('success', 'error');
            categoryError.classList.remove('show');
        } else if (length < 2) {
            this.classList.add('error');
            this.classList.remove('success');
            categoryError.textContent = 'Category must be at least 2 characters long.';
            categoryError.classList.add('show');
        } else if (length > 50) {
            this.classList.add('error');
            this.classList.remove('success');
            categoryError.textContent = 'Category cannot exceed 50 characters.';
            categoryError.classList.add('show');
        } else {
            this.classList.add('success');
            this.classList.remove('error');
            categoryError.classList.remove('show');
        }
    });

    // Description Validation
    const descInput = document.getElementById('groupDescription');
    const descCounter = document.getElementById('descCounter');
    const descError = document.getElementById('descError');

    descInput.addEventListener('input', function() {
        const length = this.value.length;
        descCounter.textContent = `${length} / 500 characters`;

        if (length > 450) {
            descCounter.classList.add('warning');
        } else {
            descCounter.classList.remove('warning');
        }

        if (length > 490) {
            descCounter.classList.add('error');
            descCounter.classList.remove('warning');
        } else {
            descCounter.classList.remove('error');
        }

        if (length === 0) {
            this.classList.remove('success', 'error');
            descError.classList.remove('show');
        } else if (length < 10) {
            this.classList.add('error');
            this.classList.remove('success');
            descError.textContent = 'Description must be at least 10 characters long.';
            descError.classList.add('show');
        } else if (length > 500) {
            this.classList.add('error');
            this.classList.remove('success');
            descError.textContent = 'Description cannot exceed 500 characters.';
            descError.classList.add('show');
        } else {
            this.classList.add('success');
            this.classList.remove('error');
            descError.classList.remove('show');
        }
    });

    // Max Participants Validation
    const participantsInput = document.getElementById('maxParticipants');
    const participantsError = document.getElementById('participantsError');

    participantsInput.addEventListener('input', function() {
        const value = parseInt(this.value);

        if (isNaN(value)) {
            this.classList.remove('success', 'error');
            participantsError.classList.remove('show');
        } else if (value < 1) {
            this.classList.add('error');
            this.classList.remove('success');
            participantsError.textContent = 'Group must allow at least 1 participant.';
            participantsError.classList.add('show');
        } else if (value > 500) {
            this.classList.add('error');
            this.classList.remove('success');
            participantsError.textContent = 'Maximum participants cannot exceed 500.';
            participantsError.classList.add('show');
        } else {
            this.classList.add('success');
            this.classList.remove('error');
            participantsError.classList.remove('show');
        }
    });

    // Handle privacy button active state
    document.querySelectorAll('.privacy-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.privacy-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Image Upload Preview
    const imageInput = document.getElementById('groupImage');
    const avatarPreview = document.getElementById('avatarPreview');

    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarPreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        }
    });

    // Form submission validation
    document.querySelector('form').addEventListener('submit', function(e) {
        let isValid = true;

        // Validate group name
        const nameValue = groupNameInput.value.trim();
        if (nameValue.length < 3 || nameValue.length > 100) {
            groupNameInput.classList.add('error');
            nameError.classList.add('show');
            isValid = false;
        }

        // Validate category
        const categoryValue = categoryInput.value.trim();
        if (categoryValue.length < 2 || categoryValue.length > 50) {
            categoryInput.classList.add('error');
            categoryError.classList.add('show');
            isValid = false;
        }

        // Validate description
        const descValue = descInput.value.trim();
        if (descValue.length < 10 || descValue.length > 500) {
            descInput.classList.add('error');
            descError.classList.add('show');
            isValid = false;
        }

        // Validate max participants
        const participantsValue = parseInt(participantsInput.value);
        if (isNaN(participantsValue) || participantsValue < 1 || participantsValue > 500) {
            participantsInput.classList.add('error');
            participantsError.classList.add('show');
            isValid = false;
        }

        if (!isValid) {
            e.preventDefault();
            alert('Please fix the errors in the form before submitting.');
            const firstError = document.querySelector('.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
</script>
{% endblock %}
