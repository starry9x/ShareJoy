{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/groups.css') }}">
{% endblock %}

{% block content %}
<div class="create-container">
    <div class="create-header">
        <a href="{{ url_for('groups') }}" class="back-link">
            <i class="fa-solid fa-arrow-left"></i> Back to Groups
        </a>
        <h1 class="create-title">Create a New Group</h1>
        <p class="create-subtitle">Build your community and connect people together</p>
    </div>

    <div class="info-box">
        <i class="info-icon fa-solid fa-lightbulb"></i>
        <p class="info-text">Creating a group makes you the owner. You'll be able to edit details and delete the group at any time.</p>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <!-- Image Upload -->
        <div class="image-upload-section">
            <div class="image-preview" id="imagePreview">
                <i class="fa-solid fa-image"></i>
            </div>
            <label for="imageUpload" class="upload-label">
                <i class="fa-solid fa-upload"></i> Choose Group Image
            </label>
            <input type="file" id="imageUpload" name="group_image" accept="image/png,image/jpeg,image/jpg,image/gif">
            <p style="margin-top: 10px; color: #757575; font-size: 0.9rem;">Optional: Upload an image (PNG, JPG, GIF - Max 5MB)</p>
            <div class="error-message" id="imageError" style="text-align: center;">Invalid file. Please upload a PNG, JPG, or GIF image under 5MB.</div>
        </div>

        <!-- Basic Info -->
        <div class="form-row" style="margin-top: 30px;">
            <div class="form-group">
                <label class="form-label">Group Name <span class="required">*</span></label>
                <input type="text" name="name" id="groupName" class="form-input" placeholder="e.g., Board Games Afternoon" maxlength="100" required>
                <div class="char-counter" id="nameCounter">0 / 100 characters</div>
                <div class="error-message" id="nameError">Please enter a group name between 3 and 100 characters.</div>
            </div>

            <div class="form-group">
                <label class="form-label">Max Participants <span class="required">*</span></label>
                <input type="number" name="max_participants" id="maxParticipants" class="form-input" value="40" min="2" max="500" required>
                <div class="error-message" id="participantsError">Please enter a number between 2 and 500.</div>
            </div>
        </div>

        <!-- Description -->
        <div class="form-group">
            <label class="form-label">Description <span class="required">*</span></label>
            <textarea name="description" id="groupDescription" class="form-textarea" placeholder="Tell people what your group is about..." maxlength="500" required></textarea>
            <div class="char-counter" id="descCounter">0 / 500 characters</div>
            <div class="error-message" id="descError">Please enter a description between 10 and 500 characters.</div>
        </div>

        <!-- Category -->
        <div class="form-group" style="margin-top: 30px;">
            <label class="form-label">Category <span class="required">*</span></label>
            <div id="categoryWrapper">
                <div class="category-options" id="categoryOptions">
                    <label class="category-btn">
                        <input type="radio" name="category" value="Creative Arts">
                        <span class="category-icon">üé®</span>
                        <span>Creative Arts</span>
                    </label>
                    <label class="category-btn">
                        <input type="radio" name="category" value="Social">
                        <span class="category-icon">üé≤</span>
                        <span>Social</span>
                    </label>
                    <label class="category-btn">
                        <input type="radio" name="category" value="Learning">
                        <span class="category-icon">üìñ</span>
                        <span>Learning</span>
                    </label>
                    <label class="category-btn">
                        <input type="radio" name="category" value="Physical">
                        <span class="category-icon">üèÉ</span>
                        <span>Physical</span>
                    </label>
                    <label class="category-btn">
                        <input type="radio" name="category" value="Nature">
                        <span class="category-icon">üå≤</span>
                        <span>Nature</span>
                    </label>
                    <label class="category-btn">
                        <input type="radio" name="category" value="Technology">
                        <span class="category-icon">üíª</span>
                        <span>Technology</span>
                    </label>
                </div>
            </div>
            <div class="category-error" id="categoryError">Please select a category for your group.</div>
        </div>

        <!-- Tags -->
        <div class="form-group" style="margin-top: 30px;">
            <label class="form-label">Tags (Press Enter to add)</label>
            <div class="tags-input-container" id="tagsContainer">
                <input type="text" class="tag-input" id="tagInput" placeholder="Add tags...">
            </div>
            <input type="hidden" name="tags" id="tagsHidden">
        </div>

        <!-- Privacy -->
        <div class="form-group" style="margin-top: 30px;">
            <label class="form-label">Group Privacy <span class="required">*</span></label>
            <div class="privacy-buttons">
                <label class="privacy-btn active">
                    <input type="radio" name="privacy" value="Public" checked>
                    üåç Public
                </label>
                <label class="privacy-btn">
                    <input type="radio" name="privacy" value="Private">
                    üîí Private
                </label>
            </div>
        </div>

        <button type="submit" class="btn-create">
            Create Group <i class="fa-solid fa-plus-circle"></i>
        </button>
    </form>
</div>

<script>
    // ========== Real-time Field Validation ==========

    // Group Name Validation
    const groupNameInput = document.getElementById('groupName');
    const nameCounter = document.getElementById('nameCounter');
    const nameError = document.getElementById('nameError');

    groupNameInput.addEventListener('input', function() {
        const length = this.value.length;
        nameCounter.textContent = `${length} / 100 characters`;

        // Update counter color
        if (length > 90) {
            nameCounter.classList.add('warning');
        } else {
            nameCounter.classList.remove('warning');
        }

        // Validation
        if (length === 0) {
            this.classList.remove('success', 'error');
            nameError.classList.remove('show');
        } else if (length < 3) {
            this.classList.add('error');
            this.classList.remove('success');
            nameError.textContent = 'Group name must be at least 3 characters long.';
            nameError.classList.add('show');
        } else if (length > 100) {
            this.classList.add('error');
            this.classList.remove('success');
            nameError.textContent = 'Group name cannot exceed 100 characters.';
            nameError.classList.add('show');
        } else {
            this.classList.add('success');
            this.classList.remove('error');
            nameError.classList.remove('show');
        }
    });

    // Description Validation
    const descInput = document.getElementById('groupDescription');
    const descCounter = document.getElementById('descCounter');
    const descError = document.getElementById('descError');

    descInput.addEventListener('input', function() {
        const length = this.value.length;
        descCounter.textContent = `${length} / 500 characters`;

        // Update counter color
        if (length > 450) {
            descCounter.classList.add('warning');
        } else {
            descCounter.classList.remove('warning');
        }

        if (length > 490) {
            descCounter.classList.add('error');
            descCounter.classList.remove('warning');
        } else {
            descCounter.classList.remove('error');
        }

        // Validation
        if (length === 0) {
            this.classList.remove('success', 'error');
            descError.classList.remove('show');
        } else if (length < 10) {
            this.classList.add('error');
            this.classList.remove('success');
            descError.textContent = 'Description must be at least 10 characters long.';
            descError.classList.add('show');
        } else if (length > 500) {
            this.classList.add('error');
            this.classList.remove('success');
            descError.textContent = 'Description cannot exceed 500 characters.';
            descError.classList.add('show');
        } else {
            this.classList.add('success');
            this.classList.remove('error');
            descError.classList.remove('show');
        }
    });

    // Max Participants Validation
    const participantsInput = document.getElementById('maxParticipants');
    const participantsError = document.getElementById('participantsError');

    participantsInput.addEventListener('input', function() {
        const value = parseInt(this.value);

        if (isNaN(value)) {
            this.classList.remove('success', 'error');
            participantsError.classList.remove('show');
        } else if (value < 2) {
            this.classList.add('error');
            this.classList.remove('success');
            participantsError.textContent = 'Group must allow at least 2 participants.';
            participantsError.classList.add('show');
        } else if (value > 500) {
            this.classList.add('error');
            this.classList.remove('success');
            participantsError.textContent = 'Maximum participants cannot exceed 500.';
            participantsError.classList.add('show');
        } else {
            this.classList.add('success');
            this.classList.remove('error');
            participantsError.classList.remove('show');
        }
    });

    // Category selection
    const categoryError = document.getElementById('categoryError');
    const categoryWrapper = document.getElementById('categoryWrapper');
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            categoryError.classList.remove('show');
            categoryWrapper.classList.remove('error');
        });
    });

    // Privacy selection
    document.querySelectorAll('.privacy-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.privacy-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Tags functionality
    const tagsContainer = document.getElementById('tagsContainer');
    const tagInput = document.getElementById('tagInput');
    const tagsHidden = document.getElementById('tagsHidden');
    const tags = [];

    tagInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const tag = this.value.trim();
            if (tag && !tags.includes(tag)) {
                tags.push(tag);
                addTagElement(tag);
                this.value = '';
                updateHiddenInput();
            }
        }
    });

    function addTagElement(tag) {
        const tagElement = document.createElement('span');
        tagElement.className = 'tag-item';
        tagElement.innerHTML = `
            #${tag}
            <span class="tag-remove" onclick="removeTag('${tag}')">&times;</span>
        `;
        tagsContainer.insertBefore(tagElement, tagInput);
    }

    function removeTag(tag) {
        const index = tags.indexOf(tag);
        if (index > -1) {
            tags.splice(index, 1);
            updateHiddenInput();
            // Remove the element
            const tagElements = document.querySelectorAll('.tag-item');
            tagElements.forEach(el => {
                if (el.textContent.includes(tag)) {
                    el.remove();
                }
            });
        }
    }

    function updateHiddenInput() {
        tagsHidden.value = tags.join(',');
    }

    // Image preview with validation
    const imageUpload = document.getElementById('imageUpload');
    const imageError = document.getElementById('imageError');
    const imagePreview = document.getElementById('imagePreview');

    imageUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];

        if (file) {
            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                imageError.textContent = 'Invalid file type. Please upload a PNG, JPG, or GIF image.';
                imageError.classList.add('show');
                this.value = '';
                imagePreview.innerHTML = '<i class="fa-solid fa-image"></i>';
                return;
            }

            // Validate file size (5MB = 5 * 1024 * 1024 bytes)
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                imageError.textContent = 'File too large. Please upload an image under 5MB.';
                imageError.classList.add('show');
                this.value = '';
                imagePreview.innerHTML = '<i class="fa-solid fa-image"></i>';
                return;
            }

            // Valid file - show preview
            imageError.classList.remove('show');
            const reader = new FileReader();
            reader.onload = function(event) {
                imagePreview.innerHTML = `<img src="${event.target.result}" alt="Group image">`;
            };
            reader.readAsDataURL(file);
        }
    });

    // Form submission validation
    document.querySelector('form').addEventListener('submit', function(e) {
        let isValid = true;

        // Validate group name
        const nameValue = groupNameInput.value.trim();
        if (nameValue.length < 3 || nameValue.length > 100) {
            groupNameInput.classList.add('error');
            nameError.classList.add('show');
            isValid = false;
        }

        // Validate description
        const descValue = descInput.value.trim();
        if (descValue.length < 10 || descValue.length > 500) {
            descInput.classList.add('error');
            descError.classList.add('show');
            isValid = false;
        }

        // Validate max participants
        const participantsValue = parseInt(participantsInput.value);
        if (isNaN(participantsValue) || participantsValue < 2 || participantsValue > 500) {
            participantsInput.classList.add('error');
            participantsError.classList.add('show');
            isValid = false;
        }

        // Validate category selection
        const categorySelected = document.querySelector('input[name="category"]:checked');
        if (!categorySelected) {
            categoryWrapper.classList.add('error');
            categoryError.classList.add('show');
            isValid = false;
        }

        if (!isValid) {
            e.preventDefault();
            // Scroll to first error
            const firstError = document.querySelector('.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
</script>
{% endblock %}
