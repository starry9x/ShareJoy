{% extends "base.html" %}

{% block extra_css %}
<style>
    body {
        background-color: #FFF8E1;
    }

    .create-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 40px;
        background-color: white;
        border-radius: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .create-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .back-link {
        display: inline-block;
        background-color: #8D6E63;
        color: white;
        padding: 10px 20px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .back-link:hover {
        background-color: #6D4C41;
        color: white;
    }

    .create-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: #3E2723;
    }

    .create-subtitle {
        font-size: 1.1rem;
        color: #5D4037;
        margin-top: 10px;
    }

    .form-section {
        margin-bottom: 30px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-weight: 700;
        color: #3E2723;
        margin-bottom: 8px;
        font-size: 1rem;
    }

    .required {
        color: #D32F2F;
    }

    .form-input,
    .form-select,
    .form-textarea {
        padding: 12px 15px;
        border: 1px solid #BDBDBD;
        border-radius: 8px;
        font-size: 1rem;
        font-family: inherit;
        outline: none;
        transition: border 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        border-color: #FF8A65;
    }

    .form-input.error,
    .form-textarea.error,
    .tags-input-container.error {
        border-color: #D32F2F;
        background-color: #FFEBEE;
    }

    .form-input.success,
    .form-textarea.success {
        border-color: #4CAF50;
        background-color: #E8F5E9;
    }

    .error-message {
        color: #D32F2F;
        font-size: 0.85rem;
        margin-top: 5px;
        display: none;
        font-weight: 600;
    }

    .error-message.show {
        display: block;
    }

    .char-counter {
        font-size: 0.85rem;
        color: #757575;
        text-align: right;
        margin-top: 5px;
    }

    .char-counter.warning {
        color: #FF6F00;
        font-weight: 700;
    }

    .char-counter.error {
        color: #D32F2F;
        font-weight: 700;
    }

    .category-error {
        color: #D32F2F;
        font-size: 0.85rem;
        margin-top: 10px;
        text-align: center;
        display: none;
        font-weight: 600;
    }

    .category-error.show {
        display: block;
    }

    .form-textarea {
        resize: vertical;
        min-height: 120px;
    }

    .category-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .category-btn {
        padding: 15px;
        border: 2px solid #BDBDBD;
        border-radius: 10px;
        background-color: white;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.2s;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .category-btn.active {
        border-color: #FF8A65;
        background-color: #FFF3E0;
        color: #D84315;
    }

    .category-btn input[type="radio"] {
        display: none;
    }

    .category-btn:hover {
        border-color: #FF8A65;
    }

    .category-icon {
        font-size: 2rem;
    }

    .privacy-buttons {
        display: flex;
        gap: 15px;
    }

    .privacy-btn {
        flex: 1;
        padding: 15px;
        border: 2px solid #BDBDBD;
        border-radius: 10px;
        background-color: white;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.2s;
        text-align: center;
    }

    .privacy-btn.active {
        border-color: #FF8A65;
        background-color: #FFF3E0;
        color: #D84315;
    }

    .privacy-btn input[type="radio"] {
        display: none;
    }

    .privacy-btn:hover {
        border-color: #FF8A65;
    }

    .tags-input-container {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        padding: 10px;
        border: 1px solid #BDBDBD;
        border-radius: 8px;
        min-height: 50px;
        background-color: white;
    }

    .tag-item {
        background-color: #E0E0E0;
        border: 1px solid #BDBDBD;
        color: #616161;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .tag-remove {
        cursor: pointer;
        color: #D32F2F;
        font-weight: bold;
    }

    .tag-input {
        border: none;
        outline: none;
        flex-grow: 1;
        min-width: 150px;
        font-size: 1rem;
    }

    .btn-create {
        background-color: #FFAB91;
        border: 2px solid #FF8A65;
        color: #3E2723;
        font-weight: 800;
        font-size: 1.3rem;
        padding: 15px 0;
        width: 100%;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 4px 0 #D84315;
        transition: transform 0.1s;
        margin-top: 30px;
    }

    .btn-create:hover {
        transform: translateY(2px);
        box-shadow: 0 2px 0 #D84315;
    }

    .info-box {
        background-color: #E1F5FE;
        border: 2px solid #81D4FA;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .info-icon {
        font-size: 2rem;
        color: #01579B;
    }

    .info-text {
        color: #01579B;
        font-weight: 600;
    }

    .image-upload-section {
        margin-top: 30px;
        padding: 20px;
        border: 2px dashed #BDBDBD;
        border-radius: 12px;
        text-align: center;
        background-color: #FAFAFA;
    }

    .image-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        margin: 0 auto 15px;
        background-color: #E0E0E0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
        color: #9E9E9E;
        overflow: hidden;
    }

    .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .upload-label {
        display: inline-block;
        background-color: #FFCC80;
        color: #3E2723;
        padding: 10px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        transition: all 0.2s;
    }

    .upload-label:hover {
        background-color: #FFA726;
    }

    #imageUpload {
        display: none;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        .category-options {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="create-container">
    <div class="create-header">
        <a href="{{ url_for('groups') }}" class="back-link">
            <i class="fa-solid fa-arrow-left"></i> Back to Groups
        </a>
        <h1 class="create-title">Create a New Group</h1>
        <p class="create-subtitle">Build your community and connect people together</p>
    </div>

    <div class="info-box">
        <i class="info-icon fa-solid fa-lightbulb"></i>
        <p class="info-text">Creating a group makes you the owner. You'll be able to edit details and delete the group at any time.</p>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <!-- Image Upload -->
        <div class="image-upload-section">
            <div class="image-preview" id="imagePreview">
                <i class="fa-solid fa-image"></i>
            </div>
            <label for="imageUpload" class="upload-label">
                <i class="fa-solid fa-upload"></i> Choose Group Image
            </label>
            <input type="file" id="imageUpload" name="group_image" accept="image/png,image/jpeg,image/jpg,image/gif">
            <p style="margin-top: 10px; color: #757575; font-size: 0.9rem;">Optional: Upload an image (PNG, JPG, GIF - Max 5MB)</p>
            <div class="error-message" id="imageError" style="text-align: center;">Invalid file. Please upload a PNG, JPG, or GIF image under 5MB.</div>
        </div>

        <!-- Basic Info -->
        <div class="form-row" style="margin-top: 30px;">
            <div class="form-group">
                <label class="form-label">Group Name <span class="required">*</span></label>
                <input type="text" name="name" id="groupName" class="form-input" placeholder="e.g., Board Games Afternoon" maxlength="100" required>
                <div class="char-counter" id="nameCounter">0 / 100 characters</div>
                <div class="error-message" id="nameError">Please enter a group name between 3 and 100 characters.</div>
            </div>

            <div class="form-group">
                <label class="form-label">Max Participants <span class="required">*</span></label>
                <input type="number" name="max_participants" id="maxParticipants" class="form-input" value="40" min="2" max="500" required>
                <div class="error-message" id="participantsError">Please enter a number between 2 and 500.</div>
            </div>
        </div>

        <!-- Description -->
        <div class="form-group">
            <label class="form-label">Description <span class="required">*</span></label>
            <textarea name="description" id="groupDescription" class="form-textarea" placeholder="Tell people what your group is about..." maxlength="500" required></textarea>
            <div class="char-counter" id="descCounter">0 / 500 characters</div>
            <div class="error-message" id="descError">Please enter a description between 10 and 500 characters.</div>
        </div>

        <!-- Category -->
        <div class="form-group" style="margin-top: 30px;">
            <label class="form-label">Category <span class="required">*</span></label>
            <div class="category-options" id="categoryOptions">
                <label class="category-btn">
                    <input type="radio" name="category" value="Social" required>
                    <span class="category-icon">üéâ</span>
                    <span>Social</span>
                </label>
                <label class="category-btn">
                    <input type="radio" name="category" value="Wellness">
                    <span class="category-icon">üßò</span>
                    <span>Wellness</span>
                </label>
                <label class="category-btn">
                    <input type="radio" name="category" value="Learning">
                    <span class="category-icon">üìö</span>
                    <span>Learning</span>
                </label>
                <label class="category-btn">
                    <input type="radio" name="category" value="Sports">
                    <span class="category-icon">‚öΩ</span>
                    <span>Sports</span>
                </label>
                <label class="category-btn">
                    <input type="radio" name="category" value="Arts">
                    <span class="category-icon">üé®</span>
                    <span>Arts</span>
                </label>
                <label class="category-btn">
                    <input type="radio" name="category" value="Other">
                    <span class="category-icon">‚ú®</span>
                    <span>Other</span>
                </label>
            </div>
            <div class="category-error" id="categoryError">Please select a category for your group.</div>
        </div>

        <!-- Tags -->
        <div class="form-group" style="margin-top: 30px;">
            <label class="form-label">Tags (Press Enter to add)</label>
            <div class="tags-input-container" id="tagsContainer">
                <input type="text" class="tag-input" id="tagInput" placeholder="Add tags...">
            </div>
            <input type="hidden" name="tags" id="tagsHidden">
        </div>

        <!-- Privacy -->
        <div class="form-group" style="margin-top: 30px;">
            <label class="form-label">Group Privacy <span class="required">*</span></label>
            <div class="privacy-buttons">
                <label class="privacy-btn active">
                    <input type="radio" name="privacy" value="Public" checked>
                    üåç Public
                </label>
                <label class="privacy-btn">
                    <input type="radio" name="privacy" value="Private">
                    üîí Private
                </label>
            </div>
        </div>

        <button type="submit" class="btn-create">
            Create Group <i class="fa-solid fa-plus-circle"></i>
        </button>
    </form>
</div>

<script>
    // ========== Real-time Field Validation ==========

    // Group Name Validation
    const groupNameInput = document.getElementById('groupName');
    const nameCounter = document.getElementById('nameCounter');
    const nameError = document.getElementById('nameError');

    groupNameInput.addEventListener('input', function() {
        const length = this.value.length;
        nameCounter.textContent = `${length} / 100 characters`;

        // Update counter color
        if (length > 90) {
            nameCounter.classList.add('warning');
        } else {
            nameCounter.classList.remove('warning');
        }

        // Validation
        if (length === 0) {
            this.classList.remove('success', 'error');
            nameError.classList.remove('show');
        } else if (length < 3) {
            this.classList.add('error');
            this.classList.remove('success');
            nameError.textContent = 'Group name must be at least 3 characters long.';
            nameError.classList.add('show');
        } else if (length > 100) {
            this.classList.add('error');
            this.classList.remove('success');
            nameError.textContent = 'Group name cannot exceed 100 characters.';
            nameError.classList.add('show');
        } else {
            this.classList.add('success');
            this.classList.remove('error');
            nameError.classList.remove('show');
        }
    });

    // Description Validation
    const descInput = document.getElementById('groupDescription');
    const descCounter = document.getElementById('descCounter');
    const descError = document.getElementById('descError');

    descInput.addEventListener('input', function() {
        const length = this.value.length;
        descCounter.textContent = `${length} / 500 characters`;

        // Update counter color
        if (length > 450) {
            descCounter.classList.add('warning');
        } else {
            descCounter.classList.remove('warning');
        }

        if (length > 490) {
            descCounter.classList.add('error');
            descCounter.classList.remove('warning');
        } else {
            descCounter.classList.remove('error');
        }

        // Validation
        if (length === 0) {
            this.classList.remove('success', 'error');
            descError.classList.remove('show');
        } else if (length < 10) {
            this.classList.add('error');
            this.classList.remove('success');
            descError.textContent = 'Description must be at least 10 characters long.';
            descError.classList.add('show');
        } else if (length > 500) {
            this.classList.add('error');
            this.classList.remove('success');
            descError.textContent = 'Description cannot exceed 500 characters.';
            descError.classList.add('show');
        } else {
            this.classList.add('success');
            this.classList.remove('error');
            descError.classList.remove('show');
        }
    });

    // Max Participants Validation
    const participantsInput = document.getElementById('maxParticipants');
    const participantsError = document.getElementById('participantsError');

    participantsInput.addEventListener('input', function() {
        const value = parseInt(this.value);

        if (isNaN(value)) {
            this.classList.remove('success', 'error');
            participantsError.classList.remove('show');
        } else if (value < 2) {
            this.classList.add('error');
            this.classList.remove('success');
            participantsError.textContent = 'Group must allow at least 2 participants.';
            participantsError.classList.add('show');
        } else if (value > 500) {
            this.classList.add('error');
            this.classList.remove('success');
            participantsError.textContent = 'Maximum participants cannot exceed 500.';
            participantsError.classList.add('show');
        } else {
            this.classList.add('success');
            this.classList.remove('error');
            participantsError.classList.remove('show');
        }
    });

    // Category selection
    const categoryError = document.getElementById('categoryError');
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            categoryError.classList.remove('show');
        });
    });

    // Privacy selection
    document.querySelectorAll('.privacy-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.privacy-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Tags functionality
    const tagsContainer = document.getElementById('tagsContainer');
    const tagInput = document.getElementById('tagInput');
    const tagsHidden = document.getElementById('tagsHidden');
    const tags = [];

    tagInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const tag = this.value.trim();
            if (tag && !tags.includes(tag)) {
                tags.push(tag);
                addTagElement(tag);
                this.value = '';
                updateHiddenInput();
            }
        }
    });

    function addTagElement(tag) {
        const tagElement = document.createElement('span');
        tagElement.className = 'tag-item';
        tagElement.innerHTML = `
            #${tag}
            <span class="tag-remove" onclick="removeTag('${tag}')">&times;</span>
        `;
        tagsContainer.insertBefore(tagElement, tagInput);
    }

    function removeTag(tag) {
        const index = tags.indexOf(tag);
        if (index > -1) {
            tags.splice(index, 1);
            updateHiddenInput();
            // Remove the element
            const tagElements = document.querySelectorAll('.tag-item');
            tagElements.forEach(el => {
                if (el.textContent.includes(tag)) {
                    el.remove();
                }
            });
        }
    }

    function updateHiddenInput() {
        tagsHidden.value = tags.join(',');
    }

    // Image preview with validation
    const imageUpload = document.getElementById('imageUpload');
    const imageError = document.getElementById('imageError');
    const imagePreview = document.getElementById('imagePreview');

    imageUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];

        if (file) {
            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                imageError.textContent = 'Invalid file type. Please upload a PNG, JPG, or GIF image.';
                imageError.classList.add('show');
                this.value = '';
                imagePreview.innerHTML = '<i class="fa-solid fa-image"></i>';
                return;
            }

            // Validate file size (5MB = 5 * 1024 * 1024 bytes)
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                imageError.textContent = 'File too large. Please upload an image under 5MB.';
                imageError.classList.add('show');
                this.value = '';
                imagePreview.innerHTML = '<i class="fa-solid fa-image"></i>';
                return;
            }

            // Valid file - show preview
            imageError.classList.remove('show');
            const reader = new FileReader();
            reader.onload = function(event) {
                imagePreview.innerHTML = `<img src="${event.target.result}" alt="Group image">`;
            };
            reader.readAsDataURL(file);
        }
    });

    // Form submission validation
    document.querySelector('form').addEventListener('submit', function(e) {
        let isValid = true;

        // Validate group name
        const nameValue = groupNameInput.value.trim();
        if (nameValue.length < 3 || nameValue.length > 100) {
            groupNameInput.classList.add('error');
            nameError.classList.add('show');
            isValid = false;
        }

        // Validate description
        const descValue = descInput.value.trim();
        if (descValue.length < 10 || descValue.length > 500) {
            descInput.classList.add('error');
            descError.classList.add('show');
            isValid = false;
        }

        // Validate max participants
        const participantsValue = parseInt(participantsInput.value);
        if (isNaN(participantsValue) || participantsValue < 2 || participantsValue > 500) {
            participantsInput.classList.add('error');
            participantsError.classList.add('show');
            isValid = false;
        }

        // Validate category selection
        const categorySelected = document.querySelector('input[name="category"]:checked');
        if (!categorySelected) {
            categoryError.classList.add('show');
            isValid = false;
        }

        if (!isValid) {
            e.preventDefault();
            alert('Please fix the errors in the form before submitting.');
            // Scroll to first error
            const firstError = document.querySelector('.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
</script>
{% endblock %}
