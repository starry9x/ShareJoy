{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/activities.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/explore.css') }}">
{% endblock %}

{% block content %}
<div class="p-3 mb-3 rounded shadow-sm box1">
    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
        <form method="get" class="flex-grow-1 mb-2 mb-md-0 box2 rounded">
            <div class="input-group">
                <input type="text" name="search" class="form-control shadow-sm searchbar"
                    placeholder="Search activities by name, category or tag..."
                    value="{{ request.args.get('search', '') }}">
                <button class="btn search-btn" type="submit">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </div>
        </form>

        <button id="toggle-filters" class="btn btn-lg fw-semibold mt-2 mt-md-0 ms-md-2">
            <i class="fa-solid fa-filter"></i> Filters
        </button>
    </div>


    <div id="filters-container" class="mt-3">

        <!-- Categories -->
        <div class="filters mb-2 d-flex flex-column">
            <span class="fw-semibold mb-2">Categories</span>
            <div class="d-flex flex-wrap gap-1">
                {% for cat in ['Creative Arts','Social','Learning','Physical','Nature','Technology'] %}
                {% set args = request.args.to_dict() %}
                {% if request.args.get('category') == cat %}
                {% set _ = args.pop('category') %}
                {% else %}
                {% set _ = args.update({'category': cat}) %}
                {% endif %}
                <a href="{{ url_for('explore', **args) }}" class="badge mb-1 filter-badge
                    {% if request.args.get('category') == cat %}active-badge{% endif %}
                    {% if cat=='Creative Arts' %} badge-creativearts
                    {% elif cat=='Social' %} badge-social
                    {% elif cat=='Learning' %} badge-learning
                    {% elif cat=='Physical' %} badge-physical
                    {% elif cat=='Nature' %} badge-nature
                    {% elif cat=='Technology' %} badge-technology
                    {% endif %}">
                    {% if cat=='Creative Arts' %}üé®{% elif cat=='Social' %}üé≤
                    {% elif cat=='Learning' %}üìñ{% elif cat=='Physical' %}üèÉ
                    {% elif cat=='Nature' %}üå≤{% elif cat=='Technology' %}üíª{% endif %}
                    {{ cat }}
                </a>

                {% endfor %}
            </div>
        </div>

        <!-- Energy -->
        <div class="filters mb-2 d-flex flex-column">
            <span class="fw-semibold mb-2">Energy Level</span>
            <div class="d-flex flex-wrap gap-1">
                {% for en in ['Low','Medium','High'] %}
                {% set args = request.args.to_dict() %}
                {% if request.args.get('energy') == en %}
                {% set _ = args.pop('energy') %}
                {% else %}
                {% set _ = args.update({'energy': en}) %}
                {% endif %}
                <a href="{{ url_for('explore', **args) }}" class="badge mb-1 filter-badge
                {% if request.args.get('energy') == en %}active-badge{% endif %}
                {% if en=='Low' %} energy-low
                {% elif en=='Medium' %} energy-medium
                {% elif en=='High' %} energy-high
                {% endif %}">
                    ‚ö°{{ en }} energy
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- Format -->
        <div class="filters mb-0 d-flex flex-column">
            <span class="fw-semibold mb-2">Format</span>
            <div class="d-flex flex-wrap gap-1">
                {% for fmt in ['Online','In-Person'] %}
                {% set args = request.args.to_dict() %}
                {% if request.args.get('format') == fmt %}
                {% set _ = args.pop('format') %}
                {% else %}
                {% set _ = args.update({'format': fmt}) %}
                {% endif %}
                <a href="{{ url_for('explore', **args) }}" class="badge mb-1 filter-badge
                {% if request.args.get('format') == fmt %}active-badge{% endif %}
                {% if fmt=='Online' %} badge-online
                {% elif fmt=='In-Person' %} badge-inperson
                {% endif %}">
                    {{ fmt }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% if request.args %}
        <div class="mt-3 text-start">
            <a href="{{ url_for('explore') }}" class="btn clearbtn fw-semibold">
                Clear all filters
            </a>
        </div>
        {% endif %}

    </div>
</div>

<div class="row g-4">
    {% if activities %}
    {% for activity in activities %}
    <div class="col-md-6">
        <div class="activity-card position-relative h-100">
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start spacing">
                <h5 class="mb-0">{{ activity.name }}</h5>

                {% if activity.type == 'Creative Arts' %}
                <span class="badge badge-creativearts category-badge mb-2 mb-sm-0">üé®Creative Arts</span>
                {% elif activity.type == 'Social' %}
                <span class="badge badge-social category-badge mb-2 mb-sm-0">üé≤Social</span>
                {% elif activity.type == 'Learning' %}
                <span class="badge badge-learning category-badge mb-2 mb-sm-0">üìñLearning</span>
                {% elif activity.type == 'Physical' %}
                <span class="badge badge-physical category-badge mb-2 mb-sm-0">üèÉPhysical</span>
                {% elif activity.type == 'Nature' %}
                <span class="badge badge-nature category-badge mb-2 mb-sm-0">üå≤Nature</span>
                {% elif activity.type == 'Technology' %}
                <span class="badge badge-technology category-badge mb-2 mb-sm-0">üíªTechnology</span>
                {% endif %}
            </div>

            <p>{{ activity.description }}</p>

            <div class="row fw-semibold spacing">
                <div class="col-12">
                    üìÖ {{ activity.display_date }}, {{ activity.display_time }}
                </div>

                <div class="col-12">‚è±
                    {% set h = activity.duration_hours %}
                    {% set m = activity.duration_minutes %}
                    {% if h and m %}
                    {{ h }} hour{% if h > 1 %}s{% endif %} {{ m }} minute{% if m > 1 %}s{% endif %}
                    {% elif h %}
                    {{ h }} hour{% if h > 1 %}s{% endif %}
                    {% elif m %}
                    {{ m }} minute{% if m > 1 %}s{% endif %}
                    {% else %}
                    0 minutes
                    {% endif %}
                </div>

                <div class="col-12">
                    {% if activity.format_type|lower == 'online' %}
                    üñ•Ô∏è Online
                    {% else %}
                    üìç {{ activity.location }}
                    {% endif %}

                </div>

            </div>

            <div class="d-flex flex-wrap gap-2 spacing">
                <span class="badge 
                        {% if activity.energy == 'Low' %}energy-low
                        {% elif activity.energy == 'Medium' %}energy-medium
                        {% elif activity.energy == 'High' %}energy-high
                        {% endif %}">
                    ‚ö°{{ activity.energy }} energy
                </span>
                <span class="badge participants">ü´Ç{{ activity.participants }}/{{ activity.max_participants }}
                    participants</span>
            </div>

            <div class="activity-tags spacing">
                {% for tag in activity.tags %}
                <span>#{{ tag }}</span>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="col-12">
        <div class="alert alert-info text-center fw-semibold">
            No activities found.
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggleBtn = document.getElementById('toggle-filters');
        const filters = document.getElementById('filters-container');

        const manuallyOpened = sessionStorage.getItem('filtersOpen');

        if (!manuallyOpened) {
            filters.classList.add('d-none');
        }

        toggleBtn.addEventListener('click', function () {
            filters.classList.toggle('d-none');

            if (!filters.classList.contains('d-none')) {
                sessionStorage.setItem('filtersOpen', 'true');
            } else {
                sessionStorage.removeItem('filtersOpen');
            }
        });
    });
</script>

{% endblock %}