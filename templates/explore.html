{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/activities.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/explore.css') }}">
{% endblock %}

{% block content %}
<div class="section-box d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
    <div>
        <h1>Explore</h1>
        <p>Explore and join various activities.</p>
    </div>
</div>
<div class="p-3 mb-3 rounded shadow-sm box1">
    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
        <form method="get" class="flex-grow-1 mb-2 mb-md-0 box2 rounded">
            <div class="input-group">
                <input type="text" name="search" class="form-control shadow-sm searchbar"
                    placeholder="Search activities by name, category or tag..."
                    value="{{ request.args.get('search', '') }}">
                <button class="btn search-btn" type="submit">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </div>
        </form>
        <button id="toggle-filters" class="btn btn-lg fw-semibold mt-2 mt-md-0 ms-md-2">
            <i class="fa-solid fa-filter"></i> Filters
        </button>
    </div>


    <div id="filters-container" class="mt-3">

        <!-- Categories -->
        <div class="filters mb-2 d-flex flex-column">
            <span class="fw-semibold mb-2">Categories</span>
            <div class="d-flex flex-wrap gap-1">
                {% for cat in ['Creative Arts','Social','Learning','Physical','Nature','Technology'] %}
                {% set args = request.args.to_dict() %}
                {% if request.args.get('category') == cat %}
                {% set _ = args.pop('category') %}
                {% else %}
                {% set _ = args.update({'category': cat}) %}
                {% endif %}
                <a href="{{ url_for('explore', **args) }}" class="badge mb-1 filter-badge
                    {% if request.args.get('category') == cat %}active-badge{% endif %}
                    {% if cat=='Creative Arts' %} badge-creativearts
                    {% elif cat=='Social' %} badge-social
                    {% elif cat=='Learning' %} badge-learning
                    {% elif cat=='Physical' %} badge-physical
                    {% elif cat=='Nature' %} badge-nature
                    {% elif cat=='Technology' %} badge-technology
                    {% endif %}">
                    {% if cat=='Creative Arts' %}üé®{% elif cat=='Social' %}üé≤
                    {% elif cat=='Learning' %}üìñ{% elif cat=='Physical' %}üèÉ
                    {% elif cat=='Nature' %}üå≤{% elif cat=='Technology' %}üíª{% endif %}
                    {{ cat }}
                </a>

                {% endfor %}
            </div>
        </div>

        <!-- Energy -->
        <div class="filters mb-2 d-flex flex-column">
            <span class="fw-semibold mb-2">Energy Level</span>
            <div class="d-flex flex-wrap gap-1">
                {% for en in ['Low','Medium','High'] %}
                {% set args = request.args.to_dict() %}
                {% if request.args.get('energy') == en %}
                {% set _ = args.pop('energy') %}
                {% else %}
                {% set _ = args.update({'energy': en}) %}
                {% endif %}
                <a href="{{ url_for('explore', **args) }}" class="badge mb-1 filter-badge
                {% if request.args.get('energy') == en %}active-badge{% endif %}
                {% if en=='Low' %} energy-low
                {% elif en=='Medium' %} energy-medium
                {% elif en=='High' %} energy-high
                {% endif %}">
                    ‚ö°{{ en }} energy
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- Format -->
        <div class="filters mb-0 d-flex flex-column">
            <span class="fw-semibold mb-2">Format</span>
            <div class="d-flex flex-wrap gap-1">
                {% for fmt in ['Online','In-Person'] %}
                {% set args = request.args.to_dict() %}
                {% if request.args.get('format') == fmt %}
                {% set _ = args.pop('format') %}
                {% else %}
                {% set _ = args.update({'format': fmt}) %}
                {% endif %}
                <a href="{{ url_for('explore', **args) }}" class="badge mb-1 filter-badge
                {% if request.args.get('format') == fmt %}active-badge{% endif %}
                {% if fmt=='Online' %} badge-online
                {% elif fmt=='In-Person' %} badge-inperson
                {% endif %}">
                    {{ fmt }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% if request.args %}
        <div class="mt-3 text-start">
            <a href="{{ url_for('explore') }}" class="btn clearbtn fw-semibold">
                Clear all filters
            </a>
        </div>
        {% endif %}

    </div>
</div>

<div class="row g-4">
    {% if activities %}
    {% for activity in activities %}
    <div class="col-md-6">
        <div class="activity-card position-relative h-100">
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start spacing">
                <h5 class="mb-0">{{ activity.name }}</h5>

                {% if activity.type == 'Creative Arts' %}
                <span class="badge badge-creativearts category-badge mb-2 mb-sm-0">üé®Creative Arts</span>
                {% elif activity.type == 'Social' %}
                <span class="badge badge-social category-badge mb-2 mb-sm-0">üé≤Social</span>
                {% elif activity.type == 'Learning' %}
                <span class="badge badge-learning category-badge mb-2 mb-sm-0">üìñLearning</span>
                {% elif activity.type == 'Physical' %}
                <span class="badge badge-physical category-badge mb-2 mb-sm-0">üèÉPhysical</span>
                {% elif activity.type == 'Nature' %}
                <span class="badge badge-nature category-badge mb-2 mb-sm-0">üå≤Nature</span>
                {% elif activity.type == 'Technology' %}
                <span class="badge badge-technology category-badge mb-2 mb-sm-0">üíªTechnology</span>
                {% endif %}
            </div>

            <p>{{ activity.description }}</p>

            <div class="row fw-semibold spacing">
                <div class="col-12">
                    üìÖ {{ activity.display_date }}, {{ activity.display_time }}
                </div>

                <div class="col-12">‚è±
                    {% set h = activity.duration_hours %}
                    {% set m = activity.duration_minutes %}
                    {% if h and m %}
                    {{ h }} hour{% if h > 1 %}s{% endif %} {{ m }} minute{% if m > 1 %}s{% endif %}
                    {% elif h %}
                    {{ h }} hour{% if h > 1 %}s{% endif %}
                    {% elif m %}
                    {{ m }} minute{% if m > 1 %}s{% endif %}
                    {% else %}
                    0 minutes
                    {% endif %}
                </div>

                <div class="col-12">
                    {% if activity.format_type|lower == 'online' %}
                    üñ•Ô∏è Online
                    {% else %}
                    üìç {{ activity.location }}
                    {% endif %}

                </div>

            </div>

            <div class="d-flex flex-wrap gap-2 spacing">
                <span class="badge 
                        {% if activity.energy == 'Low' %}energy-low
                        {% elif activity.energy == 'Medium' %}energy-medium
                        {% elif activity.energy == 'High' %}energy-high
                        {% endif %}">
                    ‚ö°{{ activity.energy }} energy
                </span>
                <span class="badge participants">ü´Ç{{ activity.participants }}/{{ activity.max_participants }}
                    participants</span>
            </div>

            <div class="activity-tags spacing">
                {% for tag in activity.display_tags %}
                <span class="tag">#{{ tag }}</span>
                {% endfor %}
            </div>

            <div class="mt-3 text-center">
                {% if activity.join_activity == 'false' %}
                <button type="button" class="btn join-btn fw-semibold w-100 shadow-sm"
                    data-activity-id="{{ activity.id }}" data-date="{{ activity.display_date }}"
                    data-time="{{ activity.display_time }}">
                    Join Activity
                </button>

                {% elif activity.join_activity == 'true' %}
                <button type="button" class="btn joined fw-semibold w-100 shadow-sm"
                    data-activity-id="{{ activity.id }}" data-date="{{ activity.display_date }}"
                    data-time="{{ activity.display_time }}">
                    Joined
                </button>

                {% elif activity.join_activity == 'max' %}
                <button type="button" class="btn maxbtn fw-semibold w-100 shadow-sm" disabled>
                    Activity Full
                </button>

                {% elif activity.join_activity == 'created' %}
                <button type="button" class="btn createdbtn fw-semibold w-100 shadow-sm" disabled>
                    Created by You
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="col-12">
        <div class="alert alert-info text-center fw-semibold">
            No activities found.
        </div>
    </div>
    {% endif %}
</div>
<!-- Join Confirmation Overlay -->
<div id="join-confirm-overlay" class="overlay hidden">
    <div class="bg-white p-4 shadow cardsec w-md-50">
        <div class="fw-bold mb-2 ms-1 cardhead">
            <h4>Join Activity</h4>
        </div>
        <p class="mb-3 ms-1 fw-semibold carddesc">
            You're about to join [insert activity name] on [insert activity date] at [insert activity time]. The
            organizer will be notified
            of your registration.
        </p>
        <div class="d-flex justify-content-end gap-3">
            <button type="button" id="join-cancel" class="btn cancel-btn btn-sm fw-semibold shadow-sm">
                Cancel
            </button>
            <button type="button" id="join-confirm" class="btn successbtn btn-sm fw-semibold shadow-sm">
                Join Activity
            </button>
        </div>
    </div>
</div>

<!-- Success Overlay -->
<div id="success-overlay" class="overlay hidden">
    <div class="text-center">
        <i class="fa-regular fa-circle-check text-success"></i>
        <div class="fw-bold mt-3 cardhead success-text">
            <h4>Activity Joined!</h4>
            <p class="carddesc success-text fw-semibold">The organizer will be notified.</p>
        </div>
        <button type="button" id="success-ok-btn" class="btn okbtn mt-1 fw-semibold shadow-sm">Okay</button>
    </div>
</div>

<!-- Leave Confirmation Overlay -->
<div id="leave-confirm-overlay" class="overlay hidden">
    <div class="bg-white p-4 shadow cardsec w-md-50">
        <div class="fw-bold mb-2 ms-1 cardhead">
            <h4>Leave Activity</h4>
        </div>
        <p class="mb-3 ms-1 fw-semibold carddesc">
            Are you sure you want to leave this activity?
        </p>
        <div class="d-flex justify-content-end gap-3">
            <button type="button" id="leave-cancel" class="btn cancel-btn btn-sm fw-semibold shadow-sm">
                Cancel
            </button>
            <button type="button" id="leave-confirm" class="btn redbtn btn-sm fw-semibold shadow-sm">
                Leave Activity
            </button>
        </div>
    </div>
</div>

<!-- Success Overlay -->
<div id="successjoined-overlay" class="overlay hidden">
    <div class="bg-white p-4 shadow cardsec">
        <h4 class="cardhead mb-2">Activity Left</h4>
        <p class="carddesc fw-semibold">The organizer will be notified.</p>

        <div class="d-flex justify-content-end">
            <button type="button" id="success-ok-btn" class="btn redbtn btn-sm fw-semibold shadow-sm">
                Okay
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="overlay hidden fs-6">
    <div class="text-center">
        <div class="spinner-border" role="status"></div>
        <p class="fw-semibold mt-2 loading-text">Loading...</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggleBtn = document.getElementById('toggle-filters');
        const filters = document.getElementById('filters-container');

        const manuallyOpened = sessionStorage.getItem('filtersOpen');
        if (!manuallyOpened) filters.classList.add('d-none');

        toggleBtn.addEventListener('click', function () {
            filters.classList.toggle('d-none');
            if (!filters.classList.contains('d-none')) {
                sessionStorage.setItem('filtersOpen', 'true');
            } else {
                sessionStorage.removeItem('filtersOpen');
            }
        });

        // Overlays
        const joinOverlay = document.getElementById('join-confirm-overlay');
        const leaveOverlay = document.getElementById('leave-confirm-overlay');
        const loadingOverlay = document.getElementById('loading-overlay');
        const successOverlay = document.getElementById('success-overlay');
        const successOverlayText = successOverlay.querySelector('.carddesc') || successOverlay.querySelector('p');
        const joinConfirmBtn = document.getElementById('join-confirm');
        const joinCancelBtn = document.getElementById('join-cancel');
        const leaveConfirmBtn = document.getElementById('leave-confirm');
        const leaveCancelBtn = document.getElementById('leave-cancel');
        const successOkBtns = successOverlay.querySelectorAll('#success-ok-btn');

        let currentBtn = null;
        let currentActivityId = null;
        let currentActivityData = {};

        document.querySelectorAll('.join-btn, .joined').forEach(btn => {
            btn.addEventListener('click', () => {
                currentBtn = btn;
                currentActivityId = btn.dataset.activityId;
                currentActivityData.name = btn.closest('.activity-card').querySelector('h5').textContent;
                currentActivityData.date = currentBtn.dataset.date;
                currentActivityData.time = currentBtn.dataset.time;

                if (btn.classList.contains('join-btn')) {
                    joinOverlay.querySelector('.carddesc').textContent = `You're about to join "${currentActivityData.name}" on ${currentActivityData.date} at ${currentActivityData.time}. The organizer will be notified of your registration.`;
                    joinOverlay.classList.remove('hidden');
                } else if (btn.classList.contains('joined')) {
                    leaveOverlay.classList.remove('hidden');
                }
            });
        });

        joinCancelBtn.addEventListener('click', () => {
            joinOverlay.classList.add('hidden');
            currentBtn = null;
            currentActivityId = null;
        });

        leaveCancelBtn.addEventListener('click', () => {
            leaveOverlay.classList.add('hidden');
            currentBtn = null;
            currentActivityId = null;
        });

        function updateJoinStatus(activityId, join) {
            loadingOverlay.classList.remove('hidden');
            const startTime = Date.now();

            return fetch('/update-join', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ activity_id: activityId, join_activity: join })
            })
                .then(res => res.json())
                .then(result => {
                    const elapsed = Date.now() - startTime;
                    const remaining = 2000 - elapsed;
                    return new Promise(resolve => {
                        setTimeout(() => {
                            loadingOverlay.classList.add('hidden');
                            resolve(result);
                        }, remaining > 0 ? remaining : 0);
                    });
                })
                .catch(err => {
                    loadingOverlay.classList.add('hidden');
                    throw err;
                });
        }

        joinConfirmBtn.addEventListener('click', async () => {
            if (currentBtn && currentActivityId) {
                joinOverlay.classList.add('hidden');

                try {
                    const result = await updateJoinStatus(currentActivityId, true);
                    if (result.success) {
                        pendingJoinChange = { btn: currentBtn, join: true };

                        successOverlayText.textContent = 'The organizer will be notified.';
                        successOverlay.classList.remove('hidden');
                    } else {
                        alert('Failed to join activity.');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error updating activity.');
                } finally {
                    currentBtn = null;
                    currentActivityId = null;
                }
            }
        });

        leaveConfirmBtn.addEventListener('click', async () => {
            if (currentBtn && currentActivityId) {
                leaveOverlay.classList.add('hidden');

                try {
                    const result = await updateJoinStatus(currentActivityId, false);
                    if (result.success) {
                        pendingJoinChange = { btn: currentBtn, join: false };

                        document.getElementById('successjoined-overlay').classList.remove('hidden');
                    } else {
                        alert('Failed to leave activity.');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error updating activity.');
                } finally {
                    currentBtn = null;
                    currentActivityId = null;
                }
            }
        });


        // Join success overlay OK
        successOkBtns.forEach(btn => btn.addEventListener('click', () => {
            successOverlay.classList.add('hidden');
            if (pendingJoinChange && pendingJoinChange.join) {
                const btnEl = pendingJoinChange.btn;
                btnEl.classList.remove('join-btn');
                btnEl.classList.add('joined');
                btnEl.textContent = 'Joined';
            }
            pendingJoinChange = null;
        }));

        // Leave success overlay OK
        document.querySelectorAll('#successjoined-overlay #success-ok-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('successjoined-overlay').classList.add('hidden');
                if (pendingJoinChange && pendingJoinChange.join === false) {
                    const btnEl = pendingJoinChange.btn;
                    btnEl.classList.remove('joined');
                    btnEl.classList.add('join-btn');
                    btnEl.textContent = 'Join Activity';
                }
                pendingJoinChange = null;
            });
        });

    });
</script>
{% endblock %}