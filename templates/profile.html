{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="profile-page">

  <!-- =====================
       PROFILE CARD
  ====================== -->
  <section class="profile-card">

    <div class="profile-top">

      <div class="profile-left">
        <div class="avatar-container">
          {% if user.profile_image %}
            <img id="profileImage" src="{{ url_for('static', filename='uploads/' + user.profile_image) }}" class="avatar" alt="Profile Picture">
          {% else %}
            <img id="profileImage" src="https://static.vecteezy.com/system/resources/thumbnails/002/534/006/small/social-media-chatting-online-blank-profile-picture-head-and-body-icon-people-standing-icon-grey-background-free-vector.jpg" class="avatar" alt="Profile Picture">
          {% endif %}
          <div class="avatar-overlay">
            <button id="uploadBtn" class="avatar-btn">
              <i class="fa-solid fa-camera"></i>
            </button>
            <button id="deleteBtn" class="avatar-btn delete-btn" style="{% if user.profile_image %}display: block;{% else %}display: none;{% endif %}">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
          <input type="file" id="imageUpload" accept="image/*" style="display: none;">
        </div>

        <div class="profile-info">
          <h1 class="profile-name">{{ user.full_name }}</h1>

          <div class="info">
            <i class="fa-solid fa-envelope"></i>
            {{ user.email }}
          </div>

          <div class="info">
            <i class="fa-solid fa-calendar"></i>
            Joined {{ joined_date }}
          </div>

          <div class="info">
            <i class="fa-solid fa-user"></i>
            "{{ user.bio or 'No bio yet' }}"
          </div>
        </div>
      </div>

      <div class="profile-right">
        <span class="tag">{{ user.age_category }}</span>

        <!-- LOG OUT -->
        <a href="{{ url_for('logout') }}" class="logout-btn">
          Log Out
        </a>
      </div>

    </div>

    <!-- HORIZONTAL LINE -->
    <hr class="divider">

    <!-- STATS -->
    <div class="stats">
      <div>
        <strong>{{ user.posts_count }}</strong>
        <span>Posts</span>
      </div>
      <div>
        <strong>{{ user.followers_count }}</strong>
        <span>Followers</span>
      </div>
      <div>
        <strong>{{ user.following_count }}</strong>
        <span>Following</span>
      </div>
    </div>

    <!-- HORIZONTAL LINE -->
    <hr class="divider">

    <!-- ACTIONS -->
    <div class="actions">
      <button id="editProfile">
        <i class="fa-solid fa-pen-to-square"></i> <span id="edit-btn-text">Edit Profile</span>
      </button>
      <button id="shareProfile">
        <i class="fa-solid fa-share-nodes"></i> Share Profile
      </button>
    </div>

  </section>

  <!-- =====================
       SETTINGS SECTION
  ====================== -->
  <section class="settings">
    <h2>Account Settings & Features</h2>

    <div class="settings-grid">

      <!-- Accessibility -->
      <div class="setting-card">
        <div class="icon-wrapper accessibility">
          <i class="fa-solid fa-universal-access"></i>
        </div>
        
        <h3>Accessibility Settings</h3>
        <p class="setting-description">
          Make the page comfortable for you. Adjust the text, colours, or layout with simple tools.
        </p>

        <ul class="setting-list">
          <li>Change font size of webpage</li>
          <li>High contrast mode</li>
          <li>Text-to-speech function</li>
        </ul>

        <a href="{{ url_for('accessibility') }}">Open →</a>
      </div>

      <!-- Safety & Privacy -->
      <div class="setting-card">
        <div class="icon-wrapper safety">
          <i class="fa-solid fa-shield-halved"></i>
        </div>
        
        <h3>Safety & Privacy</h3>
        <p class="setting-description">
          Choose what you want to share and keep your account safe in just a few easy steps.
        </p>

        <ul class="setting-list">
          <li>Guardian oversight profile (optional)</li>
          <li>Privacy controls</li>
          <li>Login security</li>
          <li>Data sharing preferences</li>
        </ul>

        <a href="{{ url_for('safetynprivacy') }}">Open →</a>
      </div>

      <!-- Achievements -->
      <div class="setting-card">
        <div class="icon-wrapper achievements">
          <i class="fa-solid fa-trophy"></i>
        </div>
        
        <h3>Achievements & Progress</h3>
        <p class="setting-description">
          See your activities and achievements. Stay motivated as you complete more together.
        </p>

        <ul class="setting-list">
          <li>Trophy and badges collection</li>
          <li>Progress tracking for consistency</li>
          <li>Activity completion stats</li>
          <li>Milestone celebrations</li>
        </ul>

        <a href="{{ url_for('achievements') }}">Open →</a>
      </div>

    </div>
  </section>

  <!-- =====================
       ABOUT ME
  ====================== -->
  <section class="about">
    <h2>
      <i class="fa-solid fa-circle-info"></i> About Me
    </h2>
    <hr class="about-divider">

    <form id="profileForm" action="{{ url_for('update_profile') }}" method="POST" enctype="multipart/form-data">
      <div class="about-box">
        <strong>Bio</strong>
        <p id="bio-text">{{ user.bio or 'Click "Edit Profile" to add your bio' }}</p>
        <textarea id="bio-edit" name="bio" class="edit-textarea" style="display: none;">{{ user.bio or '' }}</textarea>
      </div>

      <div class="about-box">
        <strong>Work</strong>
        <p id="work-text">{{ user.work or 'Click "Edit Profile" to add your work information' }}</p>
        <textarea id="work-edit" name="work" class="edit-textarea" style="display: none;">{{ user.work or '' }}</textarea>
      </div>

      <div class="about-box">
        <strong>Education</strong>
        <p id="education-text">{{ user.education or 'Click "Edit Profile" to add your education information' }}</p>
        <textarea id="education-edit" name="education" class="edit-textarea" style="display: none;">{{ user.education or '' }}</textarea>
      </div>
    </form>
  </section>

</div>

<!-- =====================
     SCRIPT
====================== -->
<script>
  let isEditMode = false;
  const defaultImage = "https://static.vecteezy.com/system/resources/thumbnails/002/534/006/small/social-media-chatting-online-blank-profile-picture-head-and-body-icon-people-standing-icon-grey-background-free-vector.jpg";
  const profileForm = document.getElementById("profileForm");

  // ===== EDIT PROFILE FUNCTIONALITY =====
  document.getElementById("editProfile").addEventListener("click", () => {
    isEditMode = !isEditMode;
    
    const editBtn = document.getElementById("edit-btn-text");
    const bioText = document.getElementById("bio-text");
    const bioEdit = document.getElementById("bio-edit");
    const workText = document.getElementById("work-text");
    const workEdit = document.getElementById("work-edit");
    const educationText = document.getElementById("education-text");
    const educationEdit = document.getElementById("education-edit");
    
    if (isEditMode) {
      // Switch to edit mode
      editBtn.textContent = "Save Profile";
      
      // Hide text, show textareas
      bioText.style.display = "none";
      bioEdit.style.display = "block";
      workText.style.display = "none";
      workEdit.style.display = "block";
      educationText.style.display = "none";
      educationEdit.style.display = "block";
    } else {
      // Save changes by submitting the form
      editBtn.textContent = "Edit Profile";
      profileForm.submit();
    }
  });
  
  // ===== SHARE PROFILE FUNCTIONALITY =====
  document.getElementById("shareProfile").addEventListener("click", () => {
    if (navigator.share) {
      navigator.share({
        title: '{{ user.full_name }} - ShareJoy Profile',
        text: 'Check out my profile on ShareJoy!',
        url: window.location.href
      }).catch(err => console.log('Error sharing:', err));
    } else {
      alert("Share feature: Copy this link to share your profile!");
    }
  });

  // ===== PROFILE PICTURE FUNCTIONALITY =====
  const profileImage = document.getElementById("profileImage");
  const uploadBtn = document.getElementById("uploadBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const imageUpload = document.getElementById("imageUpload");

  // Upload button - trigger file input
  uploadBtn.addEventListener("click", () => {
    imageUpload.click();
  });

  // Handle image upload
  imageUpload.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      // Create FormData and upload immediately
      const formData = new FormData();
      formData.append('profileImage', file);
      
      fetch('{{ url_for("update_profile") }}', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          // Preview the image immediately
          const reader = new FileReader();
          reader.onload = (event) => {
            profileImage.src = event.target.result;
            deleteBtn.style.display = "block";
          };
          reader.readAsDataURL(file);
          location.reload(); // Reload to show updated image
        }
      })
      .catch(error => console.error('Error uploading image:', error));
    }
  });

  // Delete button - restore default image
  deleteBtn.addEventListener("click", () => {
    if (confirm("Are you sure you want to remove your profile picture?")) {
      // Send request to delete profile image
      const formData = new FormData();
      formData.append('deleteProfileImage', 'true');
      
      fetch('{{ url_for("update_profile") }}', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          profileImage.src = defaultImage;
          deleteBtn.style.display = "none";
          imageUpload.value = "";
          location.reload();
        }
      })
      .catch(error => console.error('Error deleting image:', error));
    }
  });
</script>
{% endblock %}