{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="profile-page">

  <!-- =====================
       PROFILE CARD
  ====================== -->
  <section class="profile-card">

    <div class="profile-top">

      <div class="profile-left">
        <div class="avatar-container">
          {% if user.profile_image %}
            <img id="profileImage" src="{{ url_for('static', filename='uploads/' + user.profile_image) }}" class="avatar" alt="Profile Picture">
          {% else %}
            <img id="profileImage" src="https://static.vecteezy.com/system/resources/thumbnails/002/534/006/small/social-media-chatting-online-blank-profile-picture-head-and-body-icon-people-standing-icon-grey-background-free-vector.jpg" class="avatar" alt="Profile Picture">
          {% endif %}
          <div class="avatar-overlay">
            <button id="uploadBtn" class="avatar-btn">
              <i class="fa-solid fa-camera"></i>
            </button>
            <button id="deleteBtn" class="avatar-btn delete-btn" style="{% if user.profile_image %}display: block;{% else %}display: none;{% endif %}">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
          <input type="file" id="imageUpload" accept="image/*" style="display: none;">
        </div>

        <div class="profile-info">
          <h1 class="profile-name">{{ user.full_name }}</h1>

          <div class="info">
            <i class="fa-solid fa-envelope"></i>
            {{ user.email }}
          </div>

          <div class="info">
            <i class="fa-solid fa-calendar"></i>
            Joined {{ joined_date }}
          </div>

          <div class="info">
            <i class="fa-solid fa-user"></i>
            "{{ user.bio or 'No bio yet' }}"
          </div>
        </div>
      </div>

      <div class="profile-right">
        <span class="tag">{{ user.age_category }}</span>

        <!-- LOG OUT -->
        <a href="{{ url_for('logout') }}" class="logout-btn">
          Log Out
        </a>
      </div>

    </div>

    <!-- HORIZONTAL LINE -->
    <hr class="divider">

    <!-- STATS -->
    <div class="stats">
      <div>
        <strong>{{ user.posts_count }}</strong>
        <span>Posts</span>
      </div>
      <div>
        <strong>{{ user.followers_count }}</strong>
        <span>Followers</span>
      </div>
      <div>
        <strong>{{ user.following_count }}</strong>
        <span>Following</span>
      </div>
    </div>

    <!-- HORIZONTAL LINE -->
    <hr class="divider">

    <!-- ACTIONS -->
    <div class="actions">
      <button id="editProfile">
        <i class="fa-solid fa-pen-to-square"></i> Edit Profile
      </button>
      <button id="shareProfile">
        <i class="fa-solid fa-share-nodes"></i> Share Profile
      </button>
    </div>

  </section>


    <!-- HORIZONTAL LINE -->
    <hr class="divider">
    <!-- POSTS SECTION -->
    <div class="posts-section">
      <div class="posts-header">
        <h2>Posts</h2>
        {% if posts %}
          <a href="{{ url_for('all_posts') }}" class="view-all-posts">View All</a>
        {% endif %}
      </div>
      {% if posts %}
        <!-- Has Posts: Show Latest 3 -->
        <div class="posts-grid">
          {% for post in posts %}
            <div class="post-card">
              <img src="{{ url_for('static', filename='uploads/' + post.image_filename) }}" alt="Post" class="post-image">
              <div class="post-overlay">
                <p class="post-caption">{{ post.caption or 'No caption' }}</p>
                <span class="post-date">{{ post.created_at.strftime('%b %d, %Y') }}</span>
              </div>
            </div>
          {% endfor %}

          <!-- Add New Post Button (only if less than 3 posts OR always show it) -->
          <div class="add-post-card" onclick="document.getElementById('addPostModal').style.display='flex'">
            <div class="add-post-icon">
              <i class="fa-solid fa-plus"></i>
            </div>
            <p>Add Post</p>
          </div>
        </div>


      {% else %}
        <!-- No Posts: Empty State -->
        <div class="no-posts-state">
          <svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="10" y="15" width="60" height="50" rx="4" stroke="#9CA3AF" stroke-width="3" fill="none"/>
            <circle cx="28" cy="32" r="6" stroke="#9CA3AF" stroke-width="2" fill="none"/>
            <path d="M18 50L32 38L42 46L62 30" stroke="#9CA3AF" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <h4>No posts yet</h4>
          <p>Share your moments and memories</p>
          <button class="add-post-btn" onclick="document.getElementById('addPostModal').style.display='flex'">
            <i class="fa-solid fa-plus"></i> Add New Post
          </button>
        </div>
      {% endif %}
    </div>


  <!-- =====================
       SETTINGS SECTION
  ====================== -->
  <section class="settings">
    <h2>Account Settings & Features</h2>

    <div class="settings-grid">

      <!-- Accessibility -->
      <div class="setting-card">
        <div class="icon-wrapper accessibility">
          <i class="fa-solid fa-universal-access"></i>
        </div>
        
        <h3>Accessibility Settings</h3>
        <p class="setting-description">
          Make the page comfortable for you. Adjust the text, colours, or layout with simple tools.
        </p>

        <ul class="setting-list">
          <li>Change font size of webpage</li>
          <li>High contrast mode</li>
          <li>Text-to-speech function</li>
        </ul>

        <a href="{{ url_for('accessibility') }}">Open →</a>
      </div>

      <!-- Safety & Privacy -->
      <div class="setting-card">
        <div class="icon-wrapper safety">
          <i class="fa-solid fa-shield-halved"></i>
        </div>
        
        <h3>Safety & Privacy</h3>
        <p class="setting-description">
          Choose what you want to share and keep your account safe in just a few easy steps.
        </p>

        <ul class="setting-list">
          <li>Guardian oversight profile (optional)</li>
          <li>Privacy controls</li>
          <li>Login security</li>
          <li>Data sharing preferences</li>
        </ul>

        <a href="{{ url_for('safetynprivacy') }}">Open →</a>
      </div>

      <!-- Achievements -->
      <div class="setting-card">
        <div class="icon-wrapper achievements">
          <i class="fa-solid fa-trophy"></i>
        </div>
        
        <h3>Achievements & Progress</h3>
        <p class="setting-description">
          See your activities and achievements. Stay motivated as you complete more together.
        </p>

        <ul class="setting-list">
          <li>Trophy and badges collection</li>
          <li>Progress tracking for consistency</li>
          <li>Activity completion stats</li>
          <li>Milestone celebrations</li>
        </ul>

        <a href="{{ url_for('achievements') }}">Open →</a>
      </div>

    </div>
  </section>

  <!-- =====================
       ABOUT ME
  ====================== -->
  <section class="about">
    <h2>
      <i class="fa-solid fa-circle-info"></i> About Me
    </h2>
    <hr class="about-divider">

    <div class="about-box">
      <strong>Bio</strong>
      <p>{{ user.bio or 'Click "Edit Profile" to add your bio' }}</p>
    </div>

    <div class="about-box">
      <strong>Work</strong>
      <p>{{ user.work or 'Click "Edit Profile" to add your work information' }}</p>
    </div>

    <div class="about-box">
      <strong>Education</strong>
      <p>{{ user.education or 'Click "Edit Profile" to add your education information' }}</p>
    </div>

    <div class="about-box">
      <strong>Relationship</strong>
      <p>{{ user.relationship or 'Click "Edit Profile" to add your relationship status' }}</p>
    </div>

    <div class="about-box">
      <strong>Interests</strong>
      <p>{{ user.interests or 'Click "Edit Profile" to add your interests and hobbies' }}</p>
    </div>
  </section>

</div>

<!-- =====================
     ADD POST MODAL
====================== -->
<div id="addPostModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2><i class="fa-solid fa-image"></i> Add New Post</h2>
      <button class="close-modal" onclick="document.getElementById('addPostModal').style.display='none'">&times;</button>
    </div>
    
    <form action="{{ url_for('create_post') }}" method="POST" enctype="multipart/form-data">
      <div class="modal-body">
        
        <!-- Image Upload -->
        <div class="form-group">
          <label for="post-image-input"><strong>Upload Image *</strong></label>
          <div class="image-upload-area" id="imageUploadArea">
            <input type="file" id="post-image-input" name="postImage" accept="image/*" required style="display: none;">
            <div class="upload-placeholder" id="uploadPlaceholder">
              <i class="fa-solid fa-cloud-arrow-up" style="font-size: 48px; color: #9CA3AF;"></i>
              <p>Click to upload or drag and drop</p>
              <span>PNG, JPG, JPEG (Max 16MB)</span>
            </div>
            <img id="imagePreview" src="" alt="Preview" style="display: none; max-width: 100%; border-radius: 8px;">
          </div>
        </div>

        <!-- Caption -->
        <div class="form-group">
          <label for="post-caption"><strong>Caption</strong></label>
          <textarea id="post-caption" name="caption" class="edit-textarea" placeholder="Write a caption..." rows="3"></textarea>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="cancel-btn" onclick="document.getElementById('addPostModal').style.display='none'; resetPostForm();">Cancel</button>
        <button type="submit" class="save-btn">
          <i class="fa-solid fa-paper-plane"></i> Post
        </button>
      </div>
    </form>
  </div>
</div>


<!-- =====================
     EDIT PROFILE MODAL
====================== -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2><i class="fa-solid fa-pen-to-square"></i> Edit Profile</h2>
      <button class="close-modal" id="closeModal">&times;</button>
    </div>
    
    <form id="profileForm" action="{{ url_for('update_profile') }}" method="POST" enctype="multipart/form-data">
      <div class="modal-body">
        
        <div class="form-group">
          <label for="bio-edit"><strong>Bio</strong></label>
          <textarea id="bio-edit" name="bio" class="edit-textarea" placeholder="Tell us about yourself...">{{ user.bio or '' }}</textarea>
        </div>

        <div class="form-group">
          <label for="work-edit"><strong>Work</strong></label>
          <textarea id="work-edit" name="work" class="edit-textarea" placeholder="Where do you work?">{{ user.work or '' }}</textarea>
        </div>

        <div class="form-group">
          <label for="education-edit"><strong>Education</strong></label>
          <textarea id="education-edit" name="education" class="edit-textarea" placeholder="Your education background...">{{ user.education or '' }}</textarea>
        </div>

        <div class="form-group">
          <label for="relationship-edit"><strong>Relationship</strong></label>
          <textarea id="relationship-edit" name="relationship" class="edit-textarea" placeholder="Your relationship status...">{{ user.relationship or '' }}</textarea>
        </div>

        <div class="form-group">
          <label for="interests-edit"><strong>Interests</strong></label>
          <textarea id="interests-edit" name="interests" class="edit-textarea" placeholder="Your hobbies and interests...">{{ user.interests or '' }}</textarea>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="cancel-btn" id="cancelBtn">Cancel</button>
        <button type="submit" class="save-btn">
          <i class="fa-solid fa-check"></i> Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<!-- =====================
     SCRIPT
====================== -->
<script>
  const defaultImage = "https://static.vecteezy.com/system/resources/thumbnails/002/534/006/small/social-media-chatting-online-blank-profile-picture-head-and-body-icon-people-standing-icon-grey-background-free-vector.jpg";
  const modal = document.getElementById("editModal");
  const editProfileBtn = document.getElementById("editProfile");
  const closeModalBtn = document.getElementById("closeModal");
  const cancelBtn = document.getElementById("cancelBtn");

  // ===== EDIT PROFILE MODAL =====
  editProfileBtn.addEventListener("click", () => {
    modal.style.display = "flex";
  });

  closeModalBtn.addEventListener("click", () => {
    modal.style.display = "none";
  });

  cancelBtn.addEventListener("click", () => {
    modal.style.display = "none";
  });

  // Close modal when clicking outside
  window.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.style.display = "none";
    }
    const addPostModal = document.getElementById('addPostModal');
    if (e.target === addPostModal) {
      addPostModal.style.display = "none";
      resetPostForm();
    }
  });

  // Close modal on Escape key
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      if (modal.style.display === "flex") {
        modal.style.display = "none";
      }
      const addPostModal = document.getElementById('addPostModal');
      if (addPostModal.style.display === "flex") {
        addPostModal.style.display = "none";
        resetPostForm();
      }
    }
  });
  
  // ===== ADD POST MODAL =====
  const imageUploadArea = document.getElementById('imageUploadArea');
  const postImageInput = document.getElementById('post-image-input');
  const uploadPlaceholder = document.getElementById('uploadPlaceholder');
  const imagePreview = document.getElementById('imagePreview');

  imageUploadArea.addEventListener('click', () => {
    postImageInput.click();
  });

  postImageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        imagePreview.src = event.target.result;
        uploadPlaceholder.style.display = 'none';
        imagePreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  });

  function resetPostForm() {
    postImageInput.value = '';
    document.getElementById('post-caption').value = '';
    uploadPlaceholder.style.display = 'flex';
    imagePreview.style.display = 'none';
    imagePreview.src = '';
  }
  
  // ===== SHARE PROFILE FUNCTIONALITY =====
  document.getElementById("shareProfile").addEventListener("click", () => {
    if (navigator.share) {
      navigator.share({
        title: '{{ user.full_name }} - ShareJoy Profile',
        text: 'Check out my profile on ShareJoy!',
        url: window.location.href
      }).catch(err => console.log('Error sharing:', err));
    } else {
      alert("Share feature: Copy this link to share your profile!");
    }
  });

  // ===== PROFILE PICTURE FUNCTIONALITY =====
  const profileImage = document.getElementById("profileImage");
  const uploadBtn = document.getElementById("uploadBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const imageUpload = document.getElementById("imageUpload");

  uploadBtn.addEventListener("click", () => {
    imageUpload.click();
  });

  imageUpload.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const formData = new FormData();
      formData.append('profileImage', file);
      
      fetch('{{ url_for("update_profile") }}', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          const reader = new FileReader();
          reader.onload = (event) => {
            profileImage.src = event.target.result;
            deleteBtn.style.display = "block";
          };
          reader.readAsDataURL(file);
          location.reload();
        }
      })
      .catch(error => console.error('Error uploading image:', error));
    }
  });

  deleteBtn.addEventListener("click", () => {
    if (confirm("Are you sure you want to remove your profile picture?")) {
      const formData = new FormData();
      formData.append('deleteProfileImage', 'true');
      
      fetch('{{ url_for("update_profile") }}', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          profileImage.src = defaultImage;
          deleteBtn.style.display = "none";
          imageUpload.value = "";
          location.reload();
        }
      })
      .catch(error => console.error('Error deleting image:', error));
    }
  });
</script>
{% endblock %}