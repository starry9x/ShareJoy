{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/activities.css') }}">
{% endblock %}

{% block content %}

<div class="section-box d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
    <div>
        <h1>My Activities</h1>
        <p>
            You are currently managing {{ num_activities }}
            {% if num_activities == 1 %}activity{% else %}activities{% endif %}.
        </p>
    </div>
    <a href="{{ url_for('activity_create') }}" class="btn btn-danger cta-btn mt-2 mt-md-0 me-0 me-md-2 fw-semibold">
        <i class="fa-solid fa-plus" aria-hidden="true"></i> Create Activity
    </a>
</div>

<div class="row">
    {% for activity in activities %}
    <div class="col-12 card-spacing">
        <div class="activity-card position-relative">
            <div class="card-actions position-absolute top-0 end-0 d-flex gap-0">
                <button type="button" class="btn edit" data-action="edit"
                    data-url="{{ url_for('edit_activity', activity_id=activity.id) }}">
                    <i class="fa-solid fa-pen-to-square"></i>
                </button>

                <form method="post" action="{{ url_for('activity_delete', activity_id=activity.id) }}"
                    class="d-inline delete-form">
                    <button type="button" class="btn delete" data-action="delete">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </form>
            </div>

            <div class="text">
                <div class="d-flex align-items-center gap-2 spacing">
                    <h5 class="mb-0">{{ activity.name }}</h5>
                    {% if activity.type == 'Creative Arts' %}
                    <span class="badge badge-creativearts">üé®Creative Arts</span>
                    {% elif activity.type == 'Social' %}
                    <span class="badge badge-social">üé≤Social</span>
                    {% elif activity.type == 'Learning' %}
                    <span class="badge badge-learning">üìñLearning</span>
                    {% elif activity.type == 'Physical' %}
                    <span class="badge badge-physical">üèÉPhysical</span>
                    {% elif activity.type == 'Nature' %}
                    <span class="badge badge-nature">üå≤Nature</span>
                    {% elif activity.type == 'Technology' %}
                    <span class="badge badge-technology">üíªTechnology</span>
                    {% endif %}
                </div>

                <p>{{ activity.description }}</p>

                <div class="d-flex flex-wrap gap-2 fw-semibold spacing">
                    <span>
                        üìÖ {{ activity.display_date }}, {{ activity.display_time }}
                    </span>

                    <span>‚è±
                        {% set h = activity.duration_hours %}
                        {% set m = activity.duration_minutes %}
                        {% if h and m %}
                        {{ h }} hour{% if h > 1 %}s{% endif %} {{ m }} minute{% if m > 1 %}s{% endif %}
                        {% elif h %}
                        {{ h }} hour{% if h > 1 %}s{% endif %}
                        {% elif m %}
                        {{ m }} minute{% if m > 1 %}s{% endif %}
                        {% else %}
                        0 minutes
                        {% endif %}
                    </span>

                    <div class="col-12">
                        {% if activity.format_type|lower == 'online' %}
                        üñ•Ô∏è Online
                        {% else %}
                        üìç {{ activity.location }}
                        {% endif %}

                    </div>

                </div>

                <div class="d-flex flex-wrap gap-2 spacing">
                    <span class="badge 
                    {% if activity.energy == 'Low' %}energy-low
                    {% elif activity.energy == 'Medium' %}energy-medium
                    {% elif activity.energy == 'High' %}energy-high
                    {% endif %}">
                        ‚ö°{{ activity.energy }} energy
                    </span>
                    <span class="badge participants">ü´Ç{{ activity.participants }}/{{ activity.max_participants }}
                        participants</span>
                </div>

                <div class="activity-tags">
                    {% for tag in activity.tags %}
                    <span>#{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Confirm Overlay -->
    <div id="action-confirm-overlay" class="overlay hidden">
        <div class="bg-white p-4 shadow cardsec">
            <h4 id="confirm-title" class="cardhead mb-2"></h4>
            <p id="confirm-text" class="carddesc fw-semibold"></p>

            <div class="d-flex justify-content-end gap-3">
                <button id="confirm-cancel" class="btn cancel-btn btn-sm fw-semibold shadow-sm">
                    Cancel
                </button>
                <button id="confirm-ok" class="btn redbtn btn-sm fw-semibold shadow-sm">
                    Delete Activity
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="overlay hidden fs-6">
        <div class="text-center">
            <div class="spinner-border" role="status"></div>
            <p class="fw-semibold mt-2 loading-text">Loading...</p>
        </div>
    </div>

    <!-- Success Overlay -->
    <div id="success-overlay" class="overlay hidden">
        <div class="bg-white p-4 shadow cardsec">
            <h4 class="cardhead mb-2">Activity Deleted</h4>
            <p class="carddesc fw-semibold">All participants will be notified.</p>

            <div class="d-flex justify-content-end">
                <button type="button" id="success-ok-btn" class="btn redbtn btn-sm fw-semibold shadow-sm">
                    Okay
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const deleteOverlay = document.getElementById('action-confirm-overlay');
        const title = document.getElementById('confirm-title');
        const text = document.getElementById('confirm-text');
        const confirmBtn = document.getElementById('confirm-ok');
        const cancelBtn = document.getElementById('confirm-cancel');

        const loadingOverlay = document.getElementById('loading-overlay');
        const successOverlay = document.getElementById('success-overlay');
        const successOkBtn = document.getElementById('success-ok-btn');

        let pendingDeleteForm = null;

        document.querySelectorAll('.btn.edit').forEach(btn => {
            btn.addEventListener('click', () => {
                window.location.href = btn.dataset.url;
            });
        });

        document.querySelectorAll('.btn.delete').forEach(btn => {
            btn.addEventListener('click', () => {
                title.textContent = 'Delete Activity';
                text.innerHTML = 'Are you sure you want to delete this activity? <br> This action cannot be undone and all participants will be notified.';

                pendingDeleteForm = btn.closest('form');
                deleteOverlay.classList.remove('hidden');
            });
        });

        cancelBtn.addEventListener('click', () => {
            deleteOverlay.classList.add('hidden');
            pendingDeleteForm = null;
        });

        confirmBtn.addEventListener('click', () => {
            if (!pendingDeleteForm) return;
            deleteOverlay.classList.add('hidden');
            loadingOverlay.classList.remove('hidden');

            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
                successOverlay.classList.remove('hidden');
                successOverlay.querySelector('.success-text h4').textContent = 'Activity Deleted!';
                successOverlay.querySelector('.success-text p').textContent = 'The activity has been successfully deleted.';
            }, 1500);
        });

        successOkBtn.addEventListener('click', () => {
            successOverlay.classList.add('hidden');
            if (pendingDeleteForm) pendingDeleteForm.submit();
        });
    });
</script>
{% endblock %}